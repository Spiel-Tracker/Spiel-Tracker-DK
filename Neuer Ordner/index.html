<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Spiel-Tracker (PWA-ready)</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f19">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spiel-Tracker">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/icons/icon-192.png" sizes="192x192">
  <link rel="icon" href="/icons/icon-512.png" sizes="512x512">

  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --border:#1f2937;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --text-soft:#cbd5e1;
      --ghost:#0f172a;
      --ghost-border:#374151;

      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --info:#60a5fa;

      --green:#22c55e;
    }

    *{box-sizing:border-box}
    html, body{-webkit-text-size-adjust:100%;font-size:16px}
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    main{padding:14px;max-width:1100px;margin:0 auto}

    /* ===== Sticky Topbar (mit Safe-Area) ===== */
    .topbar{
      position:sticky;top:0;z-index:30;
      background:#0a0f1f;border-bottom:1px solid var(--border);
      padding:
        calc(10px + env(safe-area-inset-top))
        12px
        10px
        12px;
    }
    .topbar .row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }
    .app-title{font-weight:900;letter-spacing:.2px;justify-self:start}
    .timer{
      font-variant-numeric:tabular-nums;
      font-weight:950;
      font-size:22px;
      justify-self:center;
    }
    .score-pill{
      display:flex;gap:8px;align-items:center;justify-content:flex-end;
      padding:.28rem .65rem;border-radius:999px;
      background:#0b1220;border:1px solid var(--border);
      font-weight:900;
      justify-self:end;
      min-width:max-content;
    }
    .score-pill .dim{color:var(--muted);font-weight:800}

    /* Match: Timer gr√∂√üer + mittig */
    body.match-mode .timer{
      font-size:34px;
      letter-spacing:.5px;
    }

    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    h3{margin:0 0 10px 0;font-size:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:12px;color:var(--muted);margin:6px 0 0 0}
    .badge{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:12px;background:#0b1220;border:1px solid var(--border);color:var(--text-soft)}

    button{
      cursor:pointer;border:none;padding:.75rem .95rem;border-radius:12px;font:inherit;
      touch-action: manipulation;
      font-weight:900;
    }
    button.secondary{background:#374151;color:#fff}
    button.success{background:var(--green);color:#0b0f19}
    button.danger{background:var(--danger);color:#0b0f19}
    button.ghost{background:var(--ghost);color:var(--text);border:1px solid var(--ghost-border)}
    button:disabled{opacity:.55;cursor:not-allowed}
    select,input{
      background:var(--ghost);color:var(--text);
      border:1px solid var(--ghost-border);
      padding:.55rem .7rem;border-radius:10px;font:inherit;
      outline:none;
    }
    input::placeholder{color:#7b8798}
    [hidden]{display:none !important}
    .sep{height:1px;background:var(--border);margin:10px 0}

    /* Setup Grid */
    .setup-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
    .btn-player{
      border:1px solid var(--border);
      background:#0d1427;color:var(--text);
      transition:.15s;text-align:center;border-radius:12px;
      padding:.9rem .95rem;font-weight:900;
      position:relative;
    }
    .btn-player.out{color:var(--muted)}
    .btn-player.start{background:#133124;color:#cde9d4;border-color:#1f6f3b}
    .btn-player.bench{background:#0d2438;color:#d4e8ff;border-color:#2563eb}
    .mini-x{
      position:absolute;top:8px;right:8px;
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:#0b1220;border:1px solid var(--border);
      color:#ffffff;font-weight:900;padding:0;
    }
    .mini-x:hover{border-color:#ef4444}
    .mini-x[disabled]{opacity:.35;cursor:not-allowed}

    /* Match Player Cards */
    .list{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .player{
      background:#0d1427;border:1px solid var(--border);
      border-radius:14px;padding:12px;
      display:flex;flex-direction:column;gap:10px;
      transition:.15s;
      cursor:pointer;
      user-select:none;
      min-height:110px;
    }
    .player header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .player .name{font-weight:950;font-size:16px;letter-spacing:.1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{padding:.22rem .55rem;border-radius:999px;font-size:12px;color:#0b0f19;font-weight:900;white-space:nowrap}
    .pill.on{background:var(--green)}
    .pill.off{background:#475569;color:#e2e8f0}

    .player .meta{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .playtime-badge{
      display:inline-block;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stats{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
      white-space:nowrap;
    }
    .stat{
      background:#1f1144;color:#c7b8ff;
      padding:.22rem .55rem;border-radius:999px;
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }

    .player.on{
      border-color:var(--green);
      box-shadow:0 0 0 2px #22c55e22 inset;
    }
    .player.selected{
      border-color:var(--info);
      background:#0c1a2b;
      box-shadow:0 0 0 2px #60a5fa55 inset;
    }
    .player.off{opacity:.95;cursor:default}

    /* Timeline */
    .timeline{
      position:relative;
      max-height:260px;
      overflow:auto;
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
    }
    .timeline::before{
      content:"";
      position:absolute;top:0;bottom:0;left:50%;
      width:2px;transform:translateX(-1px);
      background:linear-gradient(to bottom, transparent 0, #233046 20px, #233046 calc(100% - 20px), transparent 100%);
      opacity:.5;pointer-events:none;
    }
    .t-item{display:flex;gap:10px;align-items:flex-start;margin:6px 0;max-width:72%}
    .t-dot{width:9px;height:9px;border-radius:50%;margin-top:6px;background:var(--muted)}
    .t-dot.goal{background:var(--success)}
    .t-dot.og{background:var(--danger)}
    .t-dot.sub{background:var(--warn)}
    .t-dot.info{background:var(--info)}
    .t-content{flex:1}
    .t-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .t-min{font-size:12px;background:#0a0f1f;border:1px solid var(--border);color:var(--text-soft);padding:.08rem .45rem;border-radius:999px}
    .t-type{font-weight:950}
    .t-details{font-size:13px;color:var(--muted);margin-top:2px}
    .t-pair{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .pair-out,.pair-in{padding:.15rem .55rem;font-size:12px;line-height:1.1;white-space:nowrap;border-radius:999px;border:1px solid transparent}
    .pair-out{background:#2a0f13;color:#ffffff;border-color:#7f1d1d}
    .pair-in{background:#0f2a1a;color:#ffffff;border-color:#166534}
    .t-marker{
      position:relative;width:fit-content;margin:6px auto;padding:.1rem .55rem;
      font-size:12px;color:#8aa4c5;background:#0a0f1f;border:1px solid #233046;border-radius:999px;
    }

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal > .box{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:920px;width:100%;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .box h4{margin:0 0 10px 0}

    .table-wrap{overflow:auto;max-height:60vh;border:1px solid var(--border);border-radius:12px;background:#0b1220}
    table.summary{width:100%;border-collapse:collapse}
    table.summary thead th{position:sticky;top:0;background:#0d1427;color:var(--text-soft)}
    table.summary th, table.summary td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    table.summary tbody tr:nth-child(even){background:#0c1324}
    .td-right{text-align:right}

    /* Swap chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--border);
      border-radius:999px;
      background:#0d1427;
      padding:.55rem .9rem;
      cursor:pointer;
      user-select:none;
      color:#ffffff;
      touch-action: manipulation;
      font-weight:950;
    }
    .chip.outPick{background:#2a0f13;border-color:#7f1d1d}
    .chip.inPick{background:#0f2a1a;border-color:#166534}

    /* Bottom Action Bar (Mobile) */
    .bottombar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(10,15,31,.92);
      border-top:1px solid var(--border);
      backdrop-filter: blur(8px);
      z-index:35;
    }
    .bottombar .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .bottombar .row button{border-radius:14px;padding:.9rem 1rem}
    .spacer-bottom{height:92px}

    @media (min-width: 820px){
      .bottombar{display:none}
      .spacer-bottom{display:none}
    }

    /* ===== Mobile: alles etwas nach unten (Statusbar/Battery √ºberdeckt sonst) ===== */
    @media (max-width: 560px){
      main{
        padding:
          calc(12px + env(safe-area-inset-top))
          12px
          12px
          12px;
      }
      /* Topbar noch etwas h√∂her, damit iOS Statusbar sicher frei bleibt */
      .topbar{
        padding:
          calc(14px + env(safe-area-inset-top))
          12px
          12px
          12px;
      }

      /* Timer auf Mobile im Match noch gr√∂√üer */
      body.match-mode .timer{font-size:38px}

      .grid2{grid-template-columns:1fr}
      .timeline{max-height:220px}

      .player{padding:10px;border-radius:12px;gap:8px;min-height:102px}
      .player .name{font-size:14px}
      .badge{font-size:11px}
      .stat{font-size:11px}
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <div class="app-title">‚öΩ Spiel-Tracker</div>

    <div class="timer" id="timer">00:00</div>

    <div class="score-pill" aria-label="Spielstand">
      <span class="dim">Wir</span> <span id="scoreUs">0</span>
      <span class="dim">:</span>
      <span id="scoreOpp">0</span> <span class="dim">Gegner</span>
    </div>
  </div>
</div>

<main>
  <!-- SETUP -->
  <section id="setupView">
    <div class="card">
      <h3>Vorbereitung</h3>

      <div class="toolbar" style="justify-content:space-between;gap:12px">
        <div style="min-width:220px">
          <label class="hint" for="onFieldMax">Feldspieler</label><br>
          <select id="onFieldMax" style="margin-top:6px;width:100%">
            <option value="11" selected>11er</option>
            <option value="10">10er</option>
            <option value="9">9er</option>
            <option value="8">8er</option>
            <option value="7">7er</option>
            <option value="6">6er</option>
            <option value="5">5er</option>
          </select>
        </div>

        <div id="counts" class="toolbar" style="justify-content:flex-end"></div>
      </div>

      <div class="sep"></div>

      <h3>Startelf/Bank ausw√§hlen</h3>
      <p class="hint">1√ó ‚Üí Startelf (gr√ºn) ¬∑ 2√ó ‚Üí Bank (blau) ¬∑ 0√ó ‚Üí nicht dabei (grau)</p>

      <div id="setupGrid" class="setup-grid" style="margin-top:10px"></div>

      <div class="toolbar" style="margin-top:12px;">
        <button id="startBtn" type="button" class="success" disabled>‚ñ∂Ô∏è Spiel starten</button>
        <button id="resetSetupBtn" type="button" class="ghost">Alle zur√ºcksetzen</button>
        <button id="resetRosterBtn" type="button" class="ghost">Kader Standard</button>
      </div>

      <div class="sep"></div>
      <h3>Kader √§ndern</h3>
      <p class="hint">Selten n√∂tig: hier kannst du Neuzug√§nge hinzuf√ºgen oder Abg√§nge l√∂schen.</p>

      <div class="toolbar" style="gap:10px;align-items:flex-end">
        <div style="flex:1;min-width:220px">
          <label class="hint" for="newPlayerName">Spieler hinzuf√ºgen</label><br>
          <input id="newPlayerName" type="text" placeholder="Name eingeben" style="margin-top:6px;width:100%"/>
        </div>
        <button id="addPlayerBtn" type="button" class="success">+ Hinzuf√ºgen</button>
      </div>

      <p class="hint">L√∂schen im Setup: ‚úï oben rechts (nur wenn Spieler grau ist). Kader wird offline gespeichert.</p>
    </div>
  </section>

  <!-- MATCH -->
  <section id="matchView" hidden>
    <div class="card">
      <h3>Spiel</h3>

      <div class="grid2">
        <button id="pauseBtn" type="button" class="secondary">‚è∏Ô∏è Pause</button>
        <button id="resumeBtn" type="button" class="success" hidden>‚ñ∂Ô∏è Weiter</button>
      </div>

      <div class="toolbar" style="margin-top:10px;justify-content:space-between;">
        <button id="swapWizardBtn" type="button" class="ghost">üîÅ Wechsel-Assistent</button>
        <div class="toolbar">
          <button id="goalBtn" type="button" class="ghost">‚öΩ Tor (markiert)</button>
          <button id="ownGoalBtn" type="button" class="ghost danger">‚ö†Ô∏è Gegentor</button>
          <button id="endBtn" type="button" class="danger">‚èπÔ∏è Spiel beenden</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="toolbar" style="justify-content:space-between;">
        <span class="badge"><b>Ereignisse</b></span>
        <button id="toggleEventsBtn" type="button" class="ghost">üìã Anzeigen</button>
      </div>
      <div id="eventsWrap" hidden style="margin-top:10px">
        <div id="eventLog" class="timeline"></div>
      </div>

      <p class="hint">Spielerkarte antippen = markieren. Wechsel nur √ºber den Wechsel-Assistenten.</p>
    </div>

    <div class="card">
      <h3>Spieler</h3>
      <div class="list" id="playerList"></div>
      <p class="hint">Nur Feldspieler k√∂nnen markiert werden (f√ºr Tor/Assist). Sortierung: Feld oben, Bank unten (A‚ÄìZ).</p>
    </div>

    <div class="spacer-bottom"></div>
  </section>
</main>

<!-- Bottom Bar (Mobile) -->
<div class="bottombar" id="bottomBar" hidden>
  <div class="row">
    <button id="bbSwap" type="button" class="ghost">üîÅ Wechsel</button>
    <button id="bbGoal" type="button" class="ghost">‚öΩ Tor</button>
    <button id="bbEnd" type="button" class="danger">‚èπÔ∏è Ende</button>
  </div>
</div>

<!-- Assist Modal -->
<div id="assistModal" class="modal" hidden>
  <div class="box">
    <h4>Assist ausw√§hlen (optional)</h4>
    <div id="assistBody"></div>
    <div class="sep"></div>
    <div class="toolbar" style="justify-content:flex-end;">
      <button id="assistNone" type="button" class="ghost">Ohne Vorlage</button>
      <button id="assistCancel" type="button" class="secondary">Abbrechen</button>
      <button id="assistConfirm" type="button" class="success">Speichern</button>
    </div>
  </div>
</div>

<!-- Summary -->
<div id="summaryModal" class="modal" hidden>
  <div class="box">
    <h4>Spielzusammenfassung</h4>
    <p class="hint">Endstand: <b>Wir <span id="sumUs">0</span> : <span id="sumOpp">0</span> Gegner</b></p>
    <div class="table-wrap">
      <table class="summary" id="summaryTable">
        <thead>
          <tr>
            <th>Spieler</th>
            <th class="td-right">Spielzeit</th>
            <th class="td-right">Tore</th>
            <th class="td-right">Vorlagen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="sep"></div>
    <div class="toolbar" style="justify-content:flex-end;">
      <button id="summaryExportTableBtn" type="button" class="ghost">‚¨áÔ∏è Export Tabelle (wie angezeigt)</button>
      <button id="summaryExportAllBtn" type="button" class="ghost">‚¨áÔ∏è Export Alles</button>
      <button id="summaryCloseBtn" type="button" class="success">Zur Vorbereitung</button>
    </div>
  </div>
</div>

<!-- Swap Wizard -->
<div id="swapWizard" class="modal" hidden>
  <div class="box">
    <h4>Wechsel-Assistent</h4>

    <div id="swapStep1">
      <p>Schritt 1: W√§hle die <b>Feldspieler</b>, die <b>raus</b> sollen (rot).</p>
      <div id="swapFieldList" class="chips"></div>
      <div class="sep"></div>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="swapCancel1" type="button" class="secondary">Abbrechen</button>
        <button id="swapNext" type="button" class="success" disabled>Weiter</button>
      </div>
    </div>

    <div id="swapStep2" hidden>
      <p>Schritt 2: W√§hle die <b>Bankspieler</b>, die <b>rein</b> sollen (gr√ºn).<br>
        Ben√∂tigt: <b><span id="swapNeeded">0</span></b> ‚Äî Ausgew√§hlt: <b><span id="swapHave">0</span></b></p>
      <div id="swapBenchList" class="chips"></div>
      <div class="sep"></div>
      <div class="toolbar" style="justify-content:space-between;">
        <button id="swapBack" type="button" class="ghost">Zur√ºck</button>
        <span class="hint">Wechselanzahl: <b><span id="swapCountLabel">0</span></b></span>
        <div>
          <button id="swapCancel2" type="button" class="secondary">Abbrechen</button>
          <button id="swapConfirm" type="button" class="success" disabled>Best√§tigen</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const STORAGE_KEY_ROSTER = "spieltracker_roster_v6_timer_center_safearea";
  const DEFAULT_ROSTER = ['Kemal','Lenny','Niti','Jon','Lucas','Rafa','Vedad','Odysseas','Jordy','Gabriel','Thiago','Julian','Alpi','Ali'];

  let players = [];
  let selection = { playerId:null };
  let events = [];
  let scoreUs = 0, scoreOpp = 0;
  let onFieldMax = 11;

  let clock = { running:false, startTs:null, offsetMs:0 };
  let timerHandle = null;
  let matchStartTs = null;

  const swapOutSet = new Set();
  const swapInSet  = new Set();
  const pairQueueOut = [];
  const pairQueueIn  = [];

  const $ = (id)=>document.getElementById(id);

  const setupView = $('setupView'), matchView = $('matchView');
  const setupGrid = $('setupGrid'), counts = $('counts');
  const playerList = $('playerList');
  const eventLogEl = $('eventLog');
  const bottomBar = $('bottomBar');

  const showSetup = ()=>{
    document.body.classList.remove('match-mode');
    setupView.hidden=false; matchView.hidden=true; bottomBar.hidden=true;
  };
  const showMatch = ()=>{
    document.body.classList.add('match-mode');
    setupView.hidden=true; matchView.hidden=false; bottomBar.hidden=false;
  };

  const now = ()=>Date.now();
  const fmtTime = (ms)=>{
    const s=Math.floor(ms/1000);
    const m=String(Math.floor(s/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0');
    return `${m}:${ss}`;
  };
  const elapsedMs = ()=> clock.running ? (clock.offsetMs + (now() - clock.startTs)) : clock.offsetMs;
  const matchMinute = ()=> Math.max(1, Math.floor(elapsedMs()/60000) + 1);

  /* Roster Persistence */
  function loadRosterNames(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_ROSTER);
      if (!raw) return DEFAULT_ROSTER.slice();
      const arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.every(x=>typeof x==="string" && x.trim().length)){
        const seen = new Set();
        const clean = [];
        arr.map(x=>x.trim()).forEach(n=>{
          const key = n.toLowerCase();
          if (!seen.has(key)){ seen.add(key); clean.push(n); }
        });
        return clean.length ? clean : DEFAULT_ROSTER.slice();
      }
      return DEFAULT_ROSTER.slice();
    }catch(_){
      return DEFAULT_ROSTER.slice();
    }
  }
  function saveRosterNames(){
    localStorage.setItem(STORAGE_KEY_ROSTER, JSON.stringify(players.map(p=>p.name)));
  }

  /* Timeline */
  function typeClass(t){
    if (t.includes('Gegentor')) return 'og';
    if (t.includes('Tor')) return 'goal';
    if (t.includes('Wechsel')) return 'sub';
    if (t.includes('pausiert') || t==='‚ñ∂Ô∏è Weiter') return 'info';
    return 'info';
  }
  function buildMergedForRender(){
    const arr = events.slice();
    const maxMin = arr.reduce((m,e)=>Math.max(m, e.min ?? 0), matchMinute());
    for (let m=5; m<=maxMin; m+=5) arr.push({ marker:true, min:m, ts:0 });
    arr.sort((a,b)=>{
      const ma=a.min??0, mb=b.min??0;
      if (ma!==mb) return ma-mb;
      const ta=a.ts??0, tb=b.ts??0;
      return ta-tb;
    });
    return arr;
  }
  function renderEventLog(){
    if (!eventLogEl) return;
    eventLogEl.innerHTML = '';
    const merged = buildMergedForRender();

    merged.forEach(e=>{
      if (e.marker){
        const mark = document.createElement('div');
        mark.className = 't-marker';
        mark.textContent = `${e.min}‚Äô`;
        eventLogEl.appendChild(mark);
        return;
      }

      const item = document.createElement('div');
      item.className = 't-item';
      const dot = document.createElement('div');
      dot.className = 't-dot ' + typeClass(e.type);
      const content = document.createElement('div');
      content.className = 't-content';

      const row1 = document.createElement('div');
      row1.className = 't-row1';
      const typeSpan = document.createElement('div');
      typeSpan.className = 't-type';
      typeSpan.textContent = e.type;
      const minSpan = document.createElement('div');
      minSpan.className = 't-min';
      minSpan.textContent = `${e.min ?? matchMinute()}‚Äô`;
      row1.appendChild(typeSpan);
      row1.appendChild(minSpan);
      content.appendChild(row1);

      if (e.outName || e.inName){
        const pair = document.createElement('div');
        pair.className = 't-pair';
        const outChip = document.createElement('span');
        outChip.className = 'pair-out';
        outChip.textContent = `Raus: ${e.outName || '‚Äî'}`;
        const inChip = document.createElement('span');
        inChip.className = 'pair-in';
        inChip.textContent = `Rein: ${e.inName || '‚Äî'}`;
        pair.appendChild(outChip);
        pair.appendChild(inChip);
        content.appendChild(pair);
      } else {
        const details = document.createElement('div');
        details.className = 't-details';
        const parts = [];
        if (e.name) parts.push(e.name);
        if (e.assistName) parts.push(`Assist: ${e.assistName}`);
        if (e.extra) parts.push(e.extra);
        if (parts.length){ details.textContent = parts.join(' ‚Ä¢ '); content.appendChild(details); }
      }

      item.appendChild(dot);
      item.appendChild(content);
      eventLogEl.appendChild(item);
    });

    eventLogEl.scrollTop = eventLogEl.scrollHeight;
  }
  function log(evt){
    if (!evt.side) evt.side = 'us';
    if (typeof evt.min === 'undefined') evt.min = matchMinute();
    events.push(evt);
    renderEventLog();
  }
  function logSubPair(outName, inName){
    log({ts: now(), type:'üîÅ Wechsel', outName, inName, side:'us'});
  }
  function queueSubOut(name){
    if (pairQueueIn.length) logSubPair(name, pairQueueIn.shift());
    else pairQueueOut.push(name);
  }
  function queueSubIn(name){
    if (pairQueueOut.length) logSubPair(pairQueueOut.shift(), name);
    else pairQueueIn.push(name);
  }

  /* Setup */
  function renderSetup(){
    const startCount = players.filter(p=>p.squad==='start').length;
    const benchCount = players.filter(p=>p.squad==='bench').length;
    const outCount   = players.filter(p=>p.squad==='out').length;

    counts.innerHTML = `
      <span class="badge">Start: <b ${startCount>onFieldMax?'style="color:#ef4444"':''}>${startCount}/${onFieldMax}</b></span>
      <span class="badge">Bank: <b>${benchCount}</b></span>
      <span class="badge">Nicht dabei: <b>${outCount}</b></span>
      <span class="badge">Kader: <b>${players.length}</b></span>
    `;

    setupGrid.innerHTML = '';
    players.forEach(p=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `btn-player ${p.squad}`;
      btn.textContent = p.name;
      btn.dataset.id = String(p.id);

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'mini-x';
      del.textContent = '‚úï';
      del.title = 'Spieler l√∂schen';
      del.dataset.action = 'delete';
      del.dataset.id = String(p.id);
      del.disabled = (p.squad !== 'out');
      btn.appendChild(del);

      setupGrid.appendChild(btn);
    });

    $('startBtn').disabled = !(startCount>0 && startCount<=onFieldMax);
  }

  function cycleState(id){
    const p = players.find(x=>x.id===id); if (!p) return;
    if (p.squad==='out'){
      const startCount = players.filter(x=>x.squad==='start').length;
      if (startCount >= onFieldMax){ alert(`Max. ${onFieldMax} in der Startelf erlaubt.`); return; }
      p.squad='start';
    } else if (p.squad==='start'){
      p.squad='bench';
    } else {
      p.squad='out';
    }
    renderSetup();
    saveRosterNames();
  }

  function buildRoster(names){
    players = names.map((name,i)=>({
      id:i+1, name,
      squad:'out',
      onField:false, totalMs:0, lastSwitchTs:null,
      goals:0, assists:0
    }));
    selection.playerId=null; scoreUs=0; scoreOpp=0; events=[];
    pairQueueOut.length=0; pairQueueIn.length=0;
    renderSetup();
    renderEventLog();
  }

  function normalizeName(s){ return (s||"").trim().replace(/\s+/g," "); }

  function addPlayer(name){
    const n = normalizeName(name);
    if (!n) return;
    if (players.some(p=>p.name.toLowerCase()===n.toLowerCase())){
      alert("Diesen Spieler gibt es schon im Kader.");
      return;
    }
    const nextId = players.length ? Math.max(...players.map(p=>p.id)) + 1 : 1;
    players.push({ id:nextId, name:n, squad:'out', onField:false, totalMs:0, lastSwitchTs:null, goals:0, assists:0 });
    renderSetup();
    saveRosterNames();
  }

  function deletePlayer(id){
    const p = players.find(x=>x.id===id);
    if (!p) return;
    if (p.squad !== 'out'){ alert("Du kannst nur Spieler l√∂schen, die gerade grau sind."); return; }
    if (!confirm(`"${p.name}" wirklich aus dem Kader l√∂schen?`)) return;
    players = players.filter(x=>x.id!==id);
    renderSetup();
    saveRosterNames();
  }

  /* Match */
  function currentPlaytime(p){
    let ms = p.totalMs;
    if (p.onField && clock.running){ ms += now() - (p.lastSwitchTs ?? now()); }
    return ms;
  }

  function getSortedInGamePlayers(){
    return players
      .filter(p => p.squad !== 'out')
      .slice()
      .sort((a, b) => {
        if (a.onField !== b.onField) return a.onField ? -1 : 1;
        return a.name.localeCompare(b.name, 'de', { sensitivity: 'base' });
      });
  }

  function renderPlayers(){
    const inGame = getSortedInGamePlayers();
    playerList.innerHTML = '';

    inGame.forEach(p=>{
      const card = document.createElement('div');
      const selected = (selection.playerId===p.id);
      card.className = 'player ' + (p.onField?'on':'off') + (selected?' selected':'');
      card.dataset.id = String(p.id);

      card.innerHTML = `
        <header>
          <div class="name">${p.name}</div>
          <span class="pill ${p.onField?'on':'off'}">${p.onField?'Feld':'Bank'}</span>
        </header>
        <div class="meta">
          <span class="badge playtime-badge">Spielzeit: <b>${fmtTime(currentPlaytime(p))}</b></span>
          <span class="stats">
            <span class="stat">‚öΩ ${p.goals||0}</span>
            <span class="stat">üÖ∞Ô∏è ${p.assists||0}</span>
          </span>
        </div>
      `;
      playerList.appendChild(card);
    });

    $('scoreUs').textContent = String(scoreUs);
    $('scoreOpp').textContent = String(scoreOpp);
  }

  function applyTickUpdate(){
    $('timer').textContent = fmtTime(elapsedMs());
    document.querySelectorAll('.player').forEach(node=>{
      const id = Number(node.dataset.id);
      const p = players.find(x=>x.id===id); if (!p) return;
      const badgeB = node.querySelector('.playtime-badge b');
      if (badgeB) badgeB.textContent = fmtTime(currentPlaytime(p));
    });
  }

  function syncPauseButtons(isRunning){
    $('pauseBtn').hidden = !isRunning;
    $('resumeBtn').hidden = isRunning;
    $('pauseBtnTop')?.classList.toggle('hidden', !isRunning);
    $('resumeBtnTop')?.classList.toggle('hidden', isRunning);
  }

  function startClock(){
    if (clock.running) return;
    clock.running = true; clock.startTs = now();
    timerHandle = setInterval(applyTickUpdate, 250);
    syncPauseButtons(true);
    log({ts: now(), type:'‚èØÔ∏è Spiel gestartet'});
  }

  function pauseClock(){
    if (!clock.running) return;
    clock.offsetMs += now() - clock.startTs;
    clock.running = false;
    clearInterval(timerHandle); timerHandle=null;
    syncPauseButtons(false);
    log({ts: now(), type:'‚è∏Ô∏è Spiel pausiert'});
  }

  function resumeClock(){
    if (clock.running) return;
    clock.running = true; clock.startTs = now();
    timerHandle = setInterval(applyTickUpdate, 250);
    syncPauseButtons(true);
    log({ts: now(), type:'‚ñ∂Ô∏è Weiter'});
  }

  function finalizeTimes(){
    const nowTs = now();
    players.forEach(p=>{
      if (p.squad!=='out' && p.onField){
        const startRef = p.lastSwitchTs ?? matchStartTs ?? nowTs;
        p.totalMs += nowTs - startRef;
        p.lastSwitchTs = null;
        p.onField = false;
      }
    });
  }

  function showSummary(){
    $('sumUs').textContent = String(scoreUs);
    $('sumOpp').textContent = String(scoreOpp);
    const tbody = $('summaryTable').querySelector('tbody');
    tbody.innerHTML = '';

    const rows = players
      .filter(p=>p.squad!=='out')
      .map(p=>({ name:p.name, ms:p.totalMs, timeStr:fmtTime(p.totalMs), goals:p.goals||0, assists:p.assists||0 }))
      .sort((a,b)=> b.ms - a.ms);

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="td-right">${r.timeStr}</td>
        <td class="td-right">${r.goals}</td>
        <td class="td-right">${r.assists}</td>
      `;
      tbody.appendChild(tr);
    });

    $('summaryModal').hidden = false;
  }

  function endMatch(){
    if (clock.running){
      clock.offsetMs += now() - clock.startTs;
      clearInterval(timerHandle); timerHandle = null;
      clock.running = false;
    }
    finalizeTimes();
    showSummary();
  }

  function closeSummaryToSetup(){
    selection.playerId = null;
    clock = { running:false, startTs:null, offsetMs:0 };
    $('timer').textContent = '00:00';
    showSetup();
    renderSetup();
    renderPlayers();
  }

  /* Swap Wizard */
  function openSwapWizard(){
    swapOutSet.clear(); swapInSet.clear();
    renderSwapStep1();
    $('swapStep1').hidden=false;
    $('swapStep2').hidden=true;
    $('swapWizard').hidden=false;
  }
  function closeSwapWizard(){
    $('swapWizard').hidden=true;
    swapOutSet.clear(); swapInSet.clear();
  }
  function renderSwapStep1(){
    const fieldList = $('swapFieldList');
    fieldList.innerHTML = '';
    players.filter(p=>p.squad!=='out' && p.onField).forEach(p=>{
      const chip = document.createElement('button');
      chip.type='button';
      chip.className = 'chip' + (swapOutSet.has(p.id) ? ' outPick' : '');
      chip.textContent = p.name;
      chip.addEventListener('click', ()=>{
        if (swapOutSet.has(p.id)) swapOutSet.delete(p.id);
        else swapOutSet.add(p.id);
        renderSwapStep1();
      });
      fieldList.appendChild(chip);
    });
    $('swapNext').disabled = (swapOutSet.size === 0);
  }
  function renderSwapStep2(){
    const need = swapOutSet.size;
    $('swapNeeded').textContent = String(need);
    $('swapHave').textContent = String(swapInSet.size);
    $('swapCountLabel').textContent = String(need);

    const benchList = $('swapBenchList');
    benchList.innerHTML = '';
    players.filter(p=>p.squad!=='out' && !p.onField).forEach(p=>{
      const chip = document.createElement('button');
      chip.type='button';
      chip.className = 'chip' + (swapInSet.has(p.id) ? ' inPick' : '');
      chip.textContent = p.name;
      chip.addEventListener('click', ()=>{
        if (swapInSet.has(p.id)) swapInSet.delete(p.id);
        else if (swapInSet.size < need) swapInSet.add(p.id);
        renderSwapStep2();
      });
      benchList.appendChild(chip);
    });
    $('swapConfirm').disabled = !(swapInSet.size === need && need>0);
  }
  function applySwapBatch(){
    const n = swapOutSet.size;
    if (n===0 || swapInSet.size!==n) return;

    const nowTs = now();
    const outArr = Array.from(swapOutSet);
    const inArr  = Array.from(swapInSet);

    for (let i=0; i<n; i++){
      const outId = outArr[i], inId = inArr[i];
      const outP = players.find(p=>p.id===outId);
      const inP  = players.find(p=>p.id===inId);
      if (!outP || !inP) continue;
      if (!outP.onField || inP.onField) continue;

      if (clock.running){ outP.totalMs += nowTs - (outP.lastSwitchTs ?? (matchStartTs || nowTs)); }
      outP.lastSwitchTs = null; outP.onField = false;
      if (selection.playerId===outP.id) selection.playerId=null;
      queueSubOut(outP.name);

      inP.onField = true; inP.lastSwitchTs = nowTs;
      queueSubIn(inP.name);
    }

    renderPlayers();
    closeSwapWizard();
  }

  /* Goals / Assists */
  function promptAssistFor(scorerId){
    const body = $('assistBody');
    const onField = players.filter(p=>p.squad!=='out' && p.onField && p.id!==scorerId);
    body.innerHTML = onField.length
      ? `<label for="assistSelect" class="hint">Assist (optional)</label><br>
         <select id="assistSelect" style="margin-top:6px;width:100%">
           <option value="">‚Äî Ohne Vorlage ‚Äî</option>
           ${onField.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
         </select>`
      : `<p class="hint">Kein Mitspieler auf dem Feld. W√§hle unten ‚ÄûOhne Vorlage‚Äú.</p>`;
    $('assistModal').hidden = false;
  }

  function recordGoalWithAssist(scorerId, assistIdOrNull){
    const scorer = players.find(p=>p.id===scorerId); if (!scorer) return;
    scoreUs += 1; $('scoreUs').textContent = String(scoreUs);
    scorer.goals = (scorer.goals||0) + 1;

    let assistName = '';
    if (assistIdOrNull){
      const a = players.find(p=>p.id===assistIdOrNull);
      if (a){ a.assists=(a.assists||0)+1; assistName=a.name; }
    }

    log({ts: now(), type:'‚öΩ Tor', name: scorer.name, assistName: assistName || undefined, side:'us'});
    renderPlayers();
  }

  function addGoalFlow(){
    if (!selection.playerId){ alert('Bitte zuerst den Torsch√ºtzen markieren.'); return; }
    const scorer = players.find(p=>p.id===selection.playerId);
    if (!scorer || !scorer.onField){ alert('Torsch√ºtze muss auf dem Feld sein.'); return; }
    promptAssistFor(scorer.id);
  }

  function ownGoal(){
    scoreOpp += 1; $('scoreOpp').textContent = String(scoreOpp);
    log({ts: now(), type:'‚ö†Ô∏è Gegentor', extra:'Gegner hat getroffen', side:'opp'});
  }

  /* Export */
  function exportCSV(){ /* unver√§ndert ‚Äì bleibt hier, aber nur in Summary Buttons genutzt */
    const lines = [];
    lines.push(['Zeit','Spielminute','Typ','Spieler','Assist','Extra','Seite','Raus','Rein'].join(','));
    events.forEach(e=>{
      const sys = new Date(e.ts).toLocaleString();
      lines.push([
        sys,
        `${e.min ?? matchMinute()}'`,
        e.type,
        (e.name||''),
        (e.assistName||''),
        (e.extra||''),
        (e.side||'us'),
        (e.outName||''),
        (e.inName||'')
      ].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
    });

    lines.push('');
    lines.push('--- Spieler-Zusammenfassung ---');
    lines.push(['Name','Spielzeit (Sekunden)','Spielzeit (mm:ss)','Tore','Assists','Endstand Wir','Endstand Gegner'].join(','));

    players.filter(p=>p.squad!=='out').forEach((p,i)=>{
      const sec = Math.round(p.totalMs/1000);
      const endCols = i===0 ? [scoreUs, scoreOpp] : ['', ''];
      lines.push([`"${p.name.replaceAll('"','""')}"`, sec, fmtTime(p.totalMs), p.goals||0, p.assists||0, ...endCols].join(','));
    });

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `spiel_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportSummaryTableCSV(){
    const table = document.getElementById('summaryTable');
    if (!table) { alert('Summary-Tabelle nicht gefunden.'); return; }

    const us = document.getElementById('sumUs')?.textContent?.trim() ?? '';
    const opp = document.getElementById('sumOpp')?.textContent?.trim() ?? '';

    const rows = Array.from(table.querySelectorAll('tr'));
    const lines = [];
    lines.push(`"Endstand","Wir ${us} : ${opp} Gegner"`);

    rows.forEach(tr=>{
      const cells = Array.from(tr.querySelectorAll('th,td')).map(td =>
        `"${td.textContent.trim().replaceAll('"','""')}"`
      );
      lines.push(cells.join(','));
    });

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `spiel_summary_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /* Start */
  function startMatch(){
    const startCount = players.filter(p=>p.squad==='start').length;
    if (startCount===0){ alert('Bitte mindestens einen Startspieler w√§hlen.'); return; }
    if (startCount>onFieldMax){ alert(`Zu viele Startspieler (max. ${onFieldMax}).`); return; }

    players.forEach(p=>{
      p.onField = (p.squad==='start');
      p.totalMs = 0; p.lastSwitchTs = null;
      p.goals = 0; p.assists = 0;
    });

    selection.playerId = null;
    scoreUs = 0; scoreOpp = 0;
    $('scoreUs').textContent = '0';
    $('scoreOpp').textContent = '0';

    events = [];
    pairQueueOut.length = 0;
    pairQueueIn.length = 0;
    renderEventLog();

    matchStartTs = now();
    players.forEach(p=>{ if (p.onField) p.lastSwitchTs = matchStartTs; });

    clock = { running:false, startTs:null, offsetMs:0 };
    $('timer').textContent = '00:00';

    renderPlayers();
    showMatch();
    startClock();
  }

  /* Bindings */
  $('startBtn').addEventListener('click', ()=>{ if(!$('startBtn').disabled) startMatch(); });

  $('addPlayerBtn').addEventListener('click', ()=>{
    const input = $('newPlayerName');
    addPlayer(input.value);
    input.value = '';
    input.focus();
  });
  $('newPlayerName').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); $('addPlayerBtn').click(); }
  });

  setupGrid.addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-action="delete"]');
    if (del){
      e.preventDefault(); e.stopPropagation();
      deletePlayer(Number(del.dataset.id));
      return;
    }
    const btn = e.target.closest('.btn-player');
    if (!btn) return;
    cycleState(Number(btn.dataset.id));
  });

  $('resetSetupBtn').addEventListener('click', ()=>{
    players.forEach(p=>p.squad='out');
    renderSetup();
    saveRosterNames();
  });

  $('resetRosterBtn').addEventListener('click', ()=>{
    if (!confirm("Standard-Kader laden? (√úberschreibt deinen gespeicherten Kader)")) return;
    localStorage.removeItem(STORAGE_KEY_ROSTER);
    buildRoster(DEFAULT_ROSTER);
    saveRosterNames();
  });

  $('onFieldMax').addEventListener('change', ()=>{
    onFieldMax = Number($('onFieldMax').value);
    const starts = players.filter(p=>p.squad==='start');
    if (starts.length > onFieldMax){
      for (let i=onFieldMax; i<starts.length; i++) starts[i].squad = 'bench';
    }
    renderSetup();
    saveRosterNames();
  });

  playerList.addEventListener('click', (e)=>{
    const card = e.target.closest('.player');
    if (!card) return;
    const id = Number(card.dataset.id);
    const p = players.find(x=>x.id===id);
    if (!p || !p.onField) return;
    selection.playerId = (selection.playerId===id ? null : id);
    renderPlayers();
  });

  $('pauseBtn').addEventListener('click', pauseClock);
  $('resumeBtn').addEventListener('click', resumeClock);
  $('endBtn').addEventListener('click', endMatch);

  $('bbSwap').addEventListener('click', openSwapWizard);
  $('bbGoal').addEventListener('click', addGoalFlow);
  $('bbEnd').addEventListener('click', endMatch);
  $('swapWizardBtn').addEventListener('click', openSwapWizard);

  $('goalBtn').addEventListener('click', addGoalFlow);
  $('ownGoalBtn').addEventListener('click', ownGoal);

  $('toggleEventsBtn').addEventListener('click', ()=>{
    const wrap = $('eventsWrap');
    const open = wrap.hidden;
    wrap.hidden = !open;
    $('toggleEventsBtn').textContent = open ? "üìã Ausblenden" : "üìã Anzeigen";
    if (open) setTimeout(()=>renderEventLog(), 0);
  });

  $('swapCancel1').addEventListener('click', closeSwapWizard);
  $('swapCancel2').addEventListener('click', closeSwapWizard);
  $('swapNext').addEventListener('click', ()=>{
    $('swapStep1').hidden = true;
    swapInSet.clear();
    renderSwapStep2();
    $('swapStep2').hidden = false;
  });
  $('swapBack').addEventListener('click', ()=>{
    $('swapStep2').hidden = true;
    renderSwapStep1();
    $('swapStep1').hidden = false;
  });
  $('swapConfirm').addEventListener('click', applySwapBatch);

  $('assistCancel').addEventListener('click', ()=>{ $('assistModal').hidden=true; });
  $('assistNone').addEventListener('click', ()=>{
    $('assistModal').hidden = true;
    recordGoalWithAssist(selection.playerId, null);
  });
  $('assistConfirm').addEventListener('click', ()=>{
    const sel = $('assistSelect');
    let assistId = null;
    if (sel && sel.value) assistId = Number(sel.value);
    $('assistModal').hidden = true;
    if (assistId === selection.playerId){ alert('Torsch√ºtze und Assist d√ºrfen nicht identisch sein.'); return; }
    recordGoalWithAssist(selection.playerId, assistId);
  });

  $('summaryExportTableBtn').addEventListener('click', exportSummaryTableCSV);
  $('summaryExportAllBtn').addEventListener('click', exportCSV);

  $('summaryCloseBtn').addEventListener('click', ()=>{
    $('summaryModal').hidden = true;
    closeSummaryToSetup();
  });

  function init(){
    buildRoster(loadRosterNames());
    showSetup();
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, {once:true});
  else init();
})();
</script>

<!-- SW unver√§ndert -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js")
        .then(() => console.log("Service Worker registriert"))
        .catch(err => console.error("SW-Fehler:", err));
    });
  }
</script>

<!-- iOS Double-Tap block (safe) -->
<script>
  (function(){
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });
  })();
</script>

</body>
</html>
