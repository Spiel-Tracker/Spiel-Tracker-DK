<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Spiel-Tracker (PWA-ready)</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f19">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spiel-Tracker">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/icons/icon-192.png" sizes="192x192">
  <link rel="icon" href="/icons/icon-512.png" sizes="512x512">

  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --border:#1f2937;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --text-soft:#cbd5e1;
      --ghost:#0f172a;
      --ghost-border:#374151;

      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --info:#60a5fa;
      --green:#22c55e;
    }

    *{box-sizing:border-box}
    html, body{-webkit-text-size-adjust:100%;font-size:16px}
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    main{padding:14px;max-width:1100px;margin:0 auto}

    /* Sticky Topbar */
    .topbar{
      position:sticky;top:0;z-index:30;
      background:#0a0f1f;border-bottom:1px solid var(--border);
      padding:calc(10px + env(safe-area-inset-top)) 12px 10px 12px;
    }
    .topbar .row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }
    .app-title{font-weight:900;letter-spacing:.2px;justify-self:start}
    .timer{
      font-variant-numeric:tabular-nums;
      font-weight:950;
      font-size:22px;
      justify-self:center;
    }
    .score-pill{
      display:flex;gap:8px;align-items:center;justify-content:flex-end;
      padding:.28rem .65rem;border-radius:999px;
      background:#0b1220;border:1px solid var(--border);
      font-weight:900;
      justify-self:end;
      min-width:max-content;
    }
    .score-pill .dim{color:var(--muted);font-weight:800}
    body.match-mode .timer{font-size:38px;letter-spacing:.6px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    h3{margin:0 0 10px 0;font-size:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .badge{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:12px;background:#0b1220;border:1px solid var(--border);color:var(--text-soft)}
    .sep{height:1px;background:var(--border);margin:10px 0}

    button{
      cursor:pointer;border:none;padding:.78rem .95rem;border-radius:12px;font:inherit;
      touch-action: manipulation;
      font-weight:900;
    }
    button.secondary{background:#374151;color:#fff}
    button.success{background:var(--green);color:#0b0f19}
    button.danger{background:var(--danger);color:#0b0f19}
    button.ghost{background:var(--ghost);color:var(--text);border:1px solid var(--ghost-border)}
    button:disabled{opacity:.55;cursor:not-allowed}
    select,input{
      background:var(--ghost);color:var(--text);
      border:1px solid var(--ghost-border);
      padding:.6rem .75rem;border-radius:10px;font:inherit;
      outline:none;
    }
    input::placeholder{color:#7b8798}
    [hidden]{display:none !important}

    /* Setup Grid */
    .setup-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
    .btn-player{
      border:1px solid var(--border);
      background:#0d1427;color:var(--text);
      transition:.15s;text-align:center;border-radius:12px;
      padding:.95rem .95rem;font-weight:900;
      position:relative;
    }
    .btn-player.out{color:var(--muted)}
    .btn-player.start{background:#133124;color:#cde9d4;border-color:#1f6f3b}
    .btn-player.bench{background:#0d2438;color:#d4e8ff;border-color:#2563eb}
    .mini-x{
      position:absolute;top:8px;right:8px;
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:#0b1220;border:1px solid var(--border);
      color:#ffffff;font-weight:900;padding:0;
    }
    .mini-x:hover{border-color:#ef4444}
    .mini-x[disabled]{opacity:.35;cursor:not-allowed}

    /* Match Player Cards */
    .list{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .player{
      background:#0d1427;border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition:.15s;
      cursor:pointer;
      user-select:none;
      min-height:172px;
      overflow:hidden;
    }
    .player header{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:start;
      gap:8px;
    }
    .player .name{
      font-weight:950;
      font-size:15px;
      letter-spacing:.1px;
      line-height:1.15;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:3;
      overflow:hidden;
    }
    .pill{
      padding:.22rem .55rem;border-radius:999px;font-size:12px;
      color:#0b0f19;font-weight:900;white-space:nowrap;
      align-self:start;
    }
    .pill.on{background:var(--green)}
    .pill.off{background:#475569;color:#e2e8f0}

    .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:nowrap;
      min-width:0;
    }
    .playtime-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .stats{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .stat{
      background:#1f1144;color:#c7b8ff;
      padding:.22rem .55rem;border-radius:999px;
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .player.on{border-color:var(--green);box-shadow:0 0 0 2px #22c55e22 inset}
    .player.selected{border-color:var(--info);background:#0c1a2b;box-shadow:0 0 0 2px #60a5fa55 inset}
    .player.off{opacity:.95}

    /* Zielbalken */
    .progress{
      height:10px;
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
    }
    .progress > span{display:block;height:100%;width:0%;background:var(--info)}
    .progress.red > span{ background: var(--danger); }
    .progress.yellow > span{ background: var(--warn); }
    .progress.green > span{ background: var(--success); }
    .subline{font-size:12px;color:var(--muted);margin-top:-4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Timeline */
    .timeline{
      position:relative;
      max-height:260px;
      overflow:auto;
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
    }
    .timeline::before{
      content:"";
      position:absolute;top:0;bottom:0;left:50%;
      width:2px;transform:translateX(-1px);
      background:linear-gradient(to bottom, transparent 0, #233046 20px, #233046 calc(100% - 20px), transparent 100%);
      opacity:.5;pointer-events:none;
    }
    .t-item{display:flex;gap:10px;align-items:flex-start;margin:6px 0;max-width:72%}
    .t-dot{width:9px;height:9px;border-radius:50%;margin-top:6px;background:var(--muted)}
    .t-dot.goal{background:var(--success)}
    .t-dot.og{background:var(--danger)}
    .t-dot.sub{background:var(--warn)}
    .t-dot.info{background:var(--info)}
    .t-content{flex:1}
    .t-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .t-min{font-size:12px;background:#0a0f1f;border:1px solid var(--border);color:var(--text-soft);padding:.08rem .45rem;border-radius:999px}
    .t-type{font-weight:950}
    .t-details{font-size:13px;color:var(--muted);margin-top:2px}
    .t-pair{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .pair-out,.pair-in{padding:.15rem .55rem;font-size:12px;line-height:1.1;white-space:nowrap;border-radius:999px;border:1px solid transparent}
    .pair-out{background:#2a0f13;color:#ffffff;border-color:#7f1d1d}
    .pair-in{background:#0f2a1a;color:#ffffff;border-color:#166534}
    .t-marker{
      position:relative;width:fit-content;margin:6px auto;padding:.1rem .55rem;
      font-size:12px;color:#8aa4c5;background:#0a0f1f;border:1px solid #233046;border-radius:999px;
    }

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal > .box{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:920px;width:100%;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .box h4{margin:0 0 10px 0}

    .table-wrap{overflow:auto;max-height:60vh;border:1px solid var(--border);border-radius:12px;background:#0b1220}
    table.summary{width:100%;border-collapse:collapse}
    table.summary thead th{position:sticky;top:0;background:#0d1427;color:var(--text-soft)}
    table.summary th, table.summary td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    table.summary tbody tr:nth-child(even){background:#0c1324}
    .td-right{text-align:right}

    /* History list */
    .history-list{display:flex;flex-direction:column;gap:10px}
    .history-item{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      background:#0d1427;
      border:1px solid var(--border);
      cursor:pointer;
    }
    .history-item:hover{border-color:#334155}
    .history-title{font-weight:950}
    .history-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .history-score{
      font-weight:950;
      padding:.2rem .6rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0b1220;
      white-space:nowrap;
    }

    /* Swap chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--border);
      border-radius:999px;
      background:#0d1427;
      padding:.55rem .9rem;
      cursor:pointer;
      user-select:none;
      color:#ffffff;
      touch-action: manipulation;
      font-weight:950;
    }
    .chip.outPick{background:#2a0f13;border-color:#7f1d1d}
    .chip.inPick{background:#0f2a1a;border-color:#166534}

    /* Bottom Action Bar (Mobile) */
    .bottombar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(10,15,31,.92);
      border-top:1px solid var(--border);
      backdrop-filter: blur(8px);
      z-index:35;
    }
    .bottombar .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .bottombar .row button{border-radius:14px;padding:.9rem 1rem}
    .spacer-bottom{height:92px}

    @media (min-width: 820px){
      .bottombar{display:none}
      .spacer-bottom{display:none}
    }

    /* Mobile: 2 Karten pro Zeile */
    @media (max-width: 820px){
      .list{grid-template-columns:repeat(2, minmax(0, 1fr))}
    }
    @media (max-width: 560px){
      main{padding:calc(12px + env(safe-area-inset-top)) 12px 12px 12px}
      .topbar{padding:calc(14px + env(safe-area-inset-top)) 12px 12px 12px}
      body.match-mode .timer{font-size:40px}
      .grid2{grid-template-columns:1fr}
      .timeline{max-height:220px}
      .player{padding:10px;border-radius:12px;gap:8px;min-height:184px}
      .badge{font-size:11px}
      .stat{font-size:11px}
      .meta{flex-wrap:wrap}
      .playtime-badge{flex:1 1 100%}
      .stats{flex:1 1 100%;justify-content:flex-start}
      .subline{white-space:normal}
    }
  </style>
</head>

<body>

  <!-- üîí Lizenz-Sperre (PIN: 1373) -->
  <div id="licenseLock" style="
    position:fixed;
    inset:0;
    background:#070A10;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:99999;
    font-family:system-ui,Arial,sans-serif;
  ">
    <div style="
      background:#0F1626;
      border:1.5px solid #2B3647;
      padding:28px;
      border-radius:18px;
      text-align:center;
      width:280px;
      color:#fff;
    ">
      <h3 style="margin:0 0 14px 0;color:white;">üîí Lizenz</h3>

      <input id="licensePin"
            type="password"
            placeholder="PIN eingeben"
            style="
              width:100%;
              margin-bottom:12px;
              padding:10px;
              text-align:center;
              font-size:18px;
            ">

      <button id="licenseUnlockBtn"
              type="button"
              style="
                width:100%;
                background:#22c55e;
                color:#07101D;
                font-weight:900;
                padding:10px;
                border-radius:10px;
                border:none;
                cursor:pointer;
              ">
        Freischalten
      </button>

      <p style="margin-top:10px;font-size:12px;color:#9ca3af;">
        Nur f√ºr autorisierte Trainer
      </p>
    </div>
  </div>

  <div class="topbar">
    <div class="row">
      <div class="app-title">‚öΩ Spiel-Tracker</div>
      <div class="timer" id="timer">00:00</div>
      <div class="score-pill">
        <span class="dim">Wir</span> <span id="scoreUs">0</span>
        <span class="dim">:</span>
        <span id="scoreOpp">0</span> <span class="dim">Gegner</span>
      </div>
    </div>
  </div>

  <main>
    <!-- SETUP -->
    <section id="setupView">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Vorbereitung</h3>
          <div class="toolbar">
            <button id="historyBtn" type="button" class="ghost">üìä Historie</button>
          </div>
        </div>

        <div class="toolbar" style="gap:10px;margin-top:10px">
          <select id="onFieldMax" style="flex:1;min-width:140px">
            <option value="11" selected>11er</option>
            <option value="10">10er</option>
            <option value="9">9er</option>
            <option value="8">8er</option>
            <option value="7">7er</option>
            <option value="6">6er</option>
            <option value="5">5er</option>
          </select>

          <input id="matchTotalMinutes" type="number" inputmode="numeric" min="1" max="300" value="60"
                 style="flex:1;min-width:140px" placeholder="Gesamtmin"/>

          <input id="opponentInput" type="text" placeholder="Gegner (optional)" style="flex:1;min-width:160px"/>
        </div>

        <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
          <div id="counts" class="toolbar"></div>
        </div>

        <div class="sep"></div>

        <div id="setupGrid" class="setup-grid"></div>

        <div class="toolbar" style="margin-top:12px;">
          <button id="startBtn" type="button" class="success" disabled>‚ñ∂Ô∏è Start</button>
          <button id="resetSetupBtn" type="button" class="ghost">Reset Auswahl</button>
          <button id="resetRosterBtn" type="button" class="ghost">Kader Standard</button>
        </div>

        <div class="sep"></div>

        <div class="toolbar" style="gap:10px;align-items:flex-end">
          <input id="newPlayerName" type="text" placeholder="Spielername" style="flex:1;min-width:220px"/>
          <button id="addPlayerBtn" type="button" class="success">+ Spieler</button>
        </div>
      </div>
    </section>

    <!-- MATCH -->
    <section id="matchView" hidden>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Spiel</h3>
          <span class="badge" id="matchOpponentBadge" hidden>vs ‚Äî</span>
        </div>

        <div class="grid2" style="margin-top:10px">
          <button id="pauseBtn" type="button" class="secondary">‚è∏Ô∏è Pause</button>
          <button id="resumeBtn" type="button" class="success" hidden>‚ñ∂Ô∏è Weiter</button>
        </div>

        <div class="toolbar" style="margin-top:10px;justify-content:space-between;">
          <button id="swapWizardBtn" type="button" class="ghost">üîÅ Wechsel</button>
          <div class="toolbar">
            <button id="goalBtn" type="button" class="ghost">‚öΩ Tor</button>
            <button id="ownGoalBtn" type="button" class="ghost danger">‚ö†Ô∏è Gegentor</button>
            <button id="endBtn" type="button" class="danger">‚èπÔ∏è Ende</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="toolbar" style="justify-content:space-between;">
          <span class="badge">Ereignisse</span>
          <button id="toggleEventsBtn" type="button" class="ghost">üìã</button>
        </div>
        <div id="eventsWrap" hidden style="margin-top:10px">
          <div id="eventLog" class="timeline"></div>
        </div>
      </div>

      <div class="card">
        <div class="toolbar" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Spieler</h3>
          <span class="badge" id="targetBadge">Ziel √ò: ‚Äî</span>
        </div>
        <div class="list" id="playerList"></div>
      </div>

      <div class="spacer-bottom"></div>
    </section>
  </main>

  <!-- Bottom Bar (Mobile) -->
  <div class="bottombar" id="bottomBar" hidden>
    <div class="row">
      <button id="bbSwap" type="button" class="ghost">üîÅ Wechsel</button>
      <button id="bbGoal" type="button" class="ghost">‚öΩ Tor</button>
      <button id="bbEnd" type="button" class="danger">‚èπÔ∏è Ende</button>
    </div>
  </div>

  <!-- Assist Modal -->
  <div id="assistModal" class="modal" hidden>
    <div class="box">
      <h4>Assist</h4>
      <div id="assistBody"></div>
      <div class="sep"></div>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="assistNone" type="button" class="ghost">Ohne</button>
        <button id="assistCancel" type="button" class="secondary">Abbrechen</button>
        <button id="assistConfirm" type="button" class="success">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div id="summaryModal" class="modal" hidden>
    <div class="box">
      <h4>Zusammenfassung</h4>
      <div class="badge" id="sumMetaLine" style="display:inline-block;margin-bottom:10px"></div>

      <div class="table-wrap">
        <table class="summary" id="summaryTable">
          <thead>
            <tr>
              <th>Spieler</th>
              <th class="td-right">Spielzeit</th>
              <th class="td-right">Tore</th>
              <th class="td-right">Vorlagen</th>
              <th>Ziel</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="summaryShareImgBtn" type="button" class="success">üì≤ WhatsApp Bild</button>
        <button id="summaryExportTableBtn" type="button" class="ghost">‚¨áÔ∏è Export Tabelle</button>
        <button id="summaryExportAllBtn" type="button" class="ghost">‚¨áÔ∏è Export Alles</button>
        <button id="summaryCloseBtn" type="button" class="success">OK</button>
      </div>
    </div>
  </div>

  <!-- Swap Wizard -->
  <div id="swapWizard" class="modal" hidden>
    <div class="box">
      <h4>Wechsel</h4>

      <div id="swapStep1">
        <div id="swapFieldList" class="chips"></div>
        <div class="sep"></div>
        <div class="toolbar" style="justify-content:flex-end;">
          <button id="swapCancel1" type="button" class="secondary">Abbrechen</button>
          <button id="swapNext" type="button" class="success" disabled>Weiter</button>
        </div>
      </div>

      <div id="swapStep2" hidden>
        <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:10px">
          <span class="badge">Raus: <b><span id="swapNeeded">0</span></b></span>
          <span class="badge">Rein: <b><span id="swapHave">0</span></b></span>
        </div>
        <div id="swapBenchList" class="chips"></div>
        <div class="sep"></div>
        <div class="toolbar" style="justify-content:space-between;">
          <button id="swapBack" type="button" class="ghost">Zur√ºck</button>
          <div>
            <button id="swapCancel2" type="button" class="secondary">Abbrechen</button>
            <button id="swapConfirm" type="button" class="success" disabled>OK</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal" hidden>
    <div class="box">
      <div class="toolbar" style="justify-content:space-between;align-items:center">
        <h4 style="margin:0">Historie</h4>
        <button id="historyCloseBtn" type="button" class="secondary">Schlie√üen</button>
      </div>

      <div class="sep"></div>

      <!-- ‚úÖ Gesamt √ºber letzte 15 Spiele -->
      <div class="card" style="margin:0 0 12px 0">
        <div class="toolbar" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Gesamt (letzte 15 Spiele)</h3>
          <button id="historyTotalsToggleBtn" type="button" class="ghost">anzeigen</button>
        </div>
        <div id="historyTotalsWrap" hidden style="margin-top:10px">
          <div class="table-wrap">
            <table class="summary" id="historyTotalsTable">
              <thead>
                <tr>
                  <th>Spieler</th>
                  <th class="td-right">Spielzeit</th>
                  <th class="td-right">Tore</th>
                  <th class="td-right">Vorlagen</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="historyList" class="history-list"></div>

      <div class="sep"></div>

      <div class="toolbar" style="justify-content:flex-end;">
        <button id="historyClearBtn" type="button" class="danger">üóëÔ∏è L√∂schen</button>
      </div>
    </div>
  </div>

  <!-- History Detail Modal -->
  <div id="historyDetailModal" class="modal" hidden>
    <div class="box">
      <div class="toolbar" style="justify-content:space-between;align-items:center">
        <h4 id="histTitle" style="margin:0">Spiel</h4>
        <button id="historyDetailCloseBtn" type="button" class="secondary">Schlie√üen</button>
      </div>

      <div class="badge" id="histMeta" style="display:inline-block;margin:10px 0"></div>

      <div class="table-wrap">
        <table class="summary" id="historyDetailTable">
          <thead>
            <tr>
              <th>Spieler</th>
              <th class="td-right">Spielzeit</th>
              <th class="td-right">Tore</th>
              <th class="td-right">Vorlagen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <div class="toolbar" style="justify-content:flex-end;">
        <button id="historyDetailExportBtn" type="button" class="ghost">‚¨áÔ∏è Export</button>
        <button id="historyDetailDeleteBtn" type="button" class="danger">üóëÔ∏è L√∂schen</button>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  /* =========================
     üîí Offline Lizenz-Check (PIN 1373)
     ========================= */
  const ADMIN_PIN = "1373";
  const LICENSE_KEY = "spieltracker_license";

  function checkLicenseGate(){
    const lock = document.getElementById("licenseLock");
    if (!lock) return;

    const licensed = localStorage.getItem(LICENSE_KEY);
    if (licensed === "true"){
      lock.style.display = "none";
      return;
    }

    const btn = document.getElementById("licenseUnlockBtn");
    const input = document.getElementById("licensePin");

    const unlock = ()=>{
      if (input.value === ADMIN_PIN){
        localStorage.setItem(LICENSE_KEY, "true");
        lock.style.display = "none";
      } else {
        input.value = "";
        input.placeholder = "Falscher PIN";
      }
    };

    btn.addEventListener("click", unlock);
    input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") unlock(); });
  }
  checkLicenseGate();

  /* =========================
     Storage Keys / Settings
     ========================= */
  const STORAGE_KEY_ROSTER = "spieltracker_roster_v11";
  const STORAGE_KEY_TOTAL_MIN = "spieltracker_matchTotalMinutes_v1";
  const STORAGE_KEY_OPPONENT = "spieltracker_opponent_v1";
  const STORAGE_KEY_HISTORY  = "spieltracker_history_v1";
  const HISTORY_LIMIT = 15;

  const DEFAULT_ROSTER = ['Kemal','Lenny','Niti','Jon','Lucas','Rafa','Vedad','Odysseas','Jordy','Gabriel','Thiago','Julian','Alpi','Ali'];

  let players = [];
  let selection = { playerId:null };
  let events = [];
  let scoreUs = 0, scoreOpp = 0;
  let onFieldMax = 11;

  let matchTotalMinutes = 60;
  let opponentName = "";

  let clock = { running:false, startTs:null, offsetMs:0 };
  let timerHandle = null;
  let matchStartTs = null;

  const swapOutSet = new Set();
  const swapInSet  = new Set();
  const pairQueueOut = [];
  const pairQueueIn  = [];

  let currentMatchId = null;

  const $ = (id)=>document.getElementById(id);

  const setupView = $('setupView'), matchView = $('matchView');
  const setupGrid = $('setupGrid'), counts = $('counts');
  const playerList = $('playerList');
  const eventLogEl = $('eventLog');
  const bottomBar = $('bottomBar');
  const targetBadge = $('targetBadge');
  const totalMinInput = $('matchTotalMinutes');
  const opponentInput = $('opponentInput');
  const matchOpponentBadge = $('matchOpponentBadge');

  const showSetup = ()=>{
    document.body.classList.remove('match-mode');
    setupView.hidden=false; matchView.hidden=true; bottomBar.hidden=true;
  };
  const showMatch = ()=>{
    document.body.classList.add('match-mode');
    setupView.hidden=true; matchView.hidden=false; bottomBar.hidden=false;
  };

  const now = ()=>Date.now();
  const fmtTime = (ms)=>{
    const s=Math.floor(ms/1000);
    const m=String(Math.floor(s/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0');
    return `${m}:${ss}`;
  };
  const elapsedMs = ()=> clock.running ? (clock.offsetMs + (now() - clock.startTs)) : clock.offsetMs;
  const matchMinute = ()=> Math.max(1, Math.floor(elapsedMs()/60000) + 1);

  function uuid(){
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function fmtDateShort(iso){
    try{ return new Date(iso).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'2-digit' }); }
    catch(_){ return iso; }
  }
  function normalizeName(s){ return (s||"").trim().replace(/\s+/g," "); }

  function loadTotalMinutes(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_TOTAL_MIN);
      if (raw) {
        const v = Number(raw);
        if (Number.isFinite(v) && v > 0) matchTotalMinutes = Math.min(300, Math.max(1, v));
      }
    }catch(_){}
    totalMinInput.value = String(matchTotalMinutes);
  }
  function saveTotalMinutes(){
    try{ localStorage.setItem(STORAGE_KEY_TOTAL_MIN, String(matchTotalMinutes)); }catch(_){}
  }

  function loadOpponent(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_OPPONENT);
      if (typeof raw === "string") opponentName = raw;
    }catch(_){}
    opponentInput.value = opponentName || "";
  }
  function saveOpponent(){
    try{ localStorage.setItem(STORAGE_KEY_OPPONENT, opponentName || ""); }catch(_){}
  }

  function loadRosterNames(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_ROSTER);
      if (!raw) return DEFAULT_ROSTER.slice();
      const arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.every(x=>typeof x==="string" && x.trim().length)){
        const seen = new Set();
        const clean = [];
        arr.map(x=>x.trim()).forEach(n=>{
          const key = n.toLowerCase();
          if (!seen.has(key)){ seen.add(key); clean.push(n); }
        });
        return clean.length ? clean : DEFAULT_ROSTER.slice();
      }
      return DEFAULT_ROSTER.slice();
    }catch(_){
      return DEFAULT_ROSTER.slice();
    }
  }
  function saveRosterNames(){
    try{ localStorage.setItem(STORAGE_KEY_ROSTER, JSON.stringify(players.map(p=>p.name))); }catch(_){}
  }

  /* ===== Historie ===== */
  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function saveHistory(list){
    try{ localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(list)); }catch(_){}
  }
  function addToHistory(matchObj){
    const list = loadHistory();
    list.unshift(matchObj);
    saveHistory(list.slice(0, HISTORY_LIMIT));
  }
  function deleteFromHistory(matchId){
    saveHistory(loadHistory().filter(m => m.id !== matchId));
  }
  function clearHistory(){
    try{ localStorage.removeItem(STORAGE_KEY_HISTORY); }catch(_){}
  }

  /* ===== Ziel ===== */
  function getActivePlayersCount(){
    return players.filter(p=>p.squad !== 'out').length;
  }
  function getTargetMinutesPerPlayer(){
    const active = getActivePlayersCount();
    const total = Math.max(1, Number(matchTotalMinutes) || 0);
    if (!active) return 0;
    return (total * onFieldMax) / active;
  }
  function updateTargetBadge(){
    const t = getTargetMinutesPerPlayer();
    targetBadge.textContent = t > 0 ? `Ziel √ò: ${Math.round(t)} min` : `Ziel √ò: ‚Äî`;
  }

  function pctClass(pct){
    let cls = 'red';
    if (pct >= 70) cls = 'green';
    else if (pct >= 45) cls = 'yellow';
    return cls;
  }

  /* ===== Timeline ===== */
  function typeClass(t){
    if (t.includes('Gegentor')) return 'og';
    if (t.includes('Tor')) return 'goal';
    if (t.includes('Wechsel')) return 'sub';
    if (t.includes('pausiert') || t==='‚ñ∂Ô∏è Weiter') return 'info';
    return 'info';
  }
  function buildMergedForRender(){
    const arr = events.slice();
    const maxMin = arr.reduce((m,e)=>Math.max(m, e.min ?? 0), matchMinute());
    for (let m=5; m<=maxMin; m+=5) arr.push({ marker:true, min:m, ts:0 });
    arr.sort((a,b)=>{
      const ma=a.min??0, mb=b.min??0;
      if (ma!==mb) return ma-mb;
      const ta=a.ts??0, tb=b.ts??0;
      return ta-tb;
    });
    return arr;
  }
  function renderEventLog(){
    eventLogEl.innerHTML = '';
    const merged = buildMergedForRender();

    merged.forEach(e=>{
      if (e.marker){
        const mark = document.createElement('div');
        mark.className = 't-marker';
        mark.textContent = `${e.min}‚Äô`;
        eventLogEl.appendChild(mark);
        return;
      }
      const item = document.createElement('div');
      item.className = 't-item';
      const dot = document.createElement('div');
      dot.className = 't-dot ' + typeClass(e.type);
      const content = document.createElement('div');
      content.className = 't-content';

      const row1 = document.createElement('div');
      row1.className = 't-row1';
      const typeSpan = document.createElement('div');
      typeSpan.className = 't-type';
      typeSpan.textContent = e.type;
      const minSpan = document.createElement('div');
      minSpan.className = 't-min';
      minSpan.textContent = `${e.min ?? matchMinute()}‚Äô`;
      row1.appendChild(typeSpan);
      row1.appendChild(minSpan);
      content.appendChild(row1);

      if (e.outName || e.inName){
        const pair = document.createElement('div');
        pair.className = 't-pair';
        const outChip = document.createElement('span');
        outChip.className = 'pair-out';
        outChip.textContent = `Raus: ${e.outName || '‚Äî'}`;
        const inChip = document.createElement('span');
        inChip.className = 'pair-in';
        inChip.textContent = `Rein: ${e.inName || '‚Äî'}`;
        pair.appendChild(outChip);
        pair.appendChild(inChip);
        content.appendChild(pair);
      } else {
        const details = document.createElement('div');
        details.className = 't-details';
        const parts = [];
        if (e.name) parts.push(e.name);
        if (e.assistName) parts.push(`Assist: ${e.assistName}`);
        if (e.extra) parts.push(e.extra);
        if (parts.length){ details.textContent = parts.join(' ‚Ä¢ '); content.appendChild(details); }
      }

      item.appendChild(dot);
      item.appendChild(content);
      eventLogEl.appendChild(item);
    });

    eventLogEl.scrollTop = eventLogEl.scrollHeight;
  }
  function log(evt){
    if (!evt.side) evt.side = 'us';
    if (typeof evt.min === 'undefined') evt.min = matchMinute();
    events.push(evt);
    renderEventLog();
  }
  function logSubPair(outName, inName){
    log({ts: now(), type:'üîÅ Wechsel', outName, inName, side:'us'});
  }
  function queueSubOut(name){
    if (pairQueueIn.length) logSubPair(name, pairQueueIn.shift());
    else pairQueueOut.push(name);
  }
  function queueSubIn(name){
    if (pairQueueOut.length) logSubPair(pairQueueOut.shift(), name);
    else pairQueueIn.push(name);
  }

  /* ===== Setup ===== */
  function renderSetup(){
    const startCount = players.filter(p=>p.squad==='start').length;
    const benchCount = players.filter(p=>p.squad==='bench').length;
    const outCount   = players.filter(p=>p.squad==='out').length;

    counts.innerHTML = `
      <span class="badge">Start: <b ${startCount>onFieldMax?'style="color:#ef4444"':''}>${startCount}/${onFieldMax}</b></span>
      <span class="badge">Bank: <b>${benchCount}</b></span>
      <span class="badge">Out: <b>${outCount}</b></span>
      <span class="badge">Kader: <b>${players.length}</b></span>
    `;

    setupGrid.innerHTML = '';
    players.forEach(p=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `btn-player ${p.squad}`;
      btn.textContent = p.name;
      btn.dataset.id = String(p.id);

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'mini-x';
      del.textContent = '‚úï';
      del.title = 'L√∂schen';
      del.dataset.action = 'delete';
      del.dataset.id = String(p.id);
      del.disabled = (p.squad !== 'out');
      btn.appendChild(del);

      setupGrid.appendChild(btn);
    });

    $('startBtn').disabled = !(startCount>0 && startCount<=onFieldMax);
    updateTargetBadge();
  }

  function cycleState(id){
    const p = players.find(x=>x.id===id); if (!p) return;
    if (p.squad==='out'){
      const startCount = players.filter(x=>x.squad==='start').length;
      if (startCount >= onFieldMax){ alert(`Max. ${onFieldMax} Startspieler.`); return; }
      p.squad='start';
    } else if (p.squad==='start'){
      p.squad='bench';
    } else {
      p.squad='out';
    }
    renderSetup();
    saveRosterNames();
  }

  function buildRoster(names){
    players = names.map((name,i)=>({
      id:i+1, name,
      squad:'out',
      onField:false, totalMs:0, lastSwitchTs:null,
      goals:0, assists:0
    }));
    selection.playerId=null; scoreUs=0; scoreOpp=0; events=[];
    pairQueueOut.length=0; pairQueueIn.length=0;
    renderSetup();
    renderEventLog();
  }

  function addPlayer(name){
    const n = normalizeName(name);
    if (!n) return;
    if (players.some(p=>p.name.toLowerCase()===n.toLowerCase())){
      alert("Spieler existiert bereits.");
      return;
    }
    const nextId = players.length ? Math.max(...players.map(p=>p.id)) + 1 : 1;
    players.push({ id:nextId, name:n, squad:'out', onField:false, totalMs:0, lastSwitchTs:null, goals:0, assists:0 });
    renderSetup();
    saveRosterNames();
  }

  function deletePlayer(id){
    const p = players.find(x=>x.id===id);
    if (!p) return;
    if (p.squad !== 'out'){ alert("Nur graue Spieler l√∂schbar."); return; }
    if (!confirm(`"${p.name}" l√∂schen?`)) return;
    players = players.filter(x=>x.id!==id);
    renderSetup();
    saveRosterNames();
  }

  /* ===== Match ===== */
  function currentPlaytime(p){
    let ms = p.totalMs;
    if (p.onField && clock.running){ ms += now() - (p.lastSwitchTs ?? now()); }
    return ms;
  }

  function getSortedInGamePlayers(){
    return players
      .filter(p => p.squad !== 'out')
      .slice()
      .sort((a, b) => {
        if (a.onField !== b.onField) return a.onField ? -1 : 1;
        return a.name.localeCompare(b.name, 'de', { sensitivity: 'base' });
      });
  }

  function renderPlayers(){
    const inGame = getSortedInGamePlayers();
    playerList.innerHTML = '';

    const targetMin = getTargetMinutesPerPlayer();
    updateTargetBadge();

    inGame.forEach(p=>{
      const card = document.createElement('div');
      const selected = (selection.playerId===p.id);
      card.className = 'player ' + (p.onField?'on':'off') + (selected?' selected':'');
      card.dataset.id = String(p.id);

      const playedMin = currentPlaytime(p) / 60000;
      const pct = (targetMin > 0) ? Math.min(100, (playedMin/targetMin)*100) : 0;

      const cls = pctClass(pct);

      const remaining = Math.max(0, targetMin - playedMin);
      const sub = targetMin>0 ? `√ò ${Math.round(targetMin)} min ‚Ä¢ ${Math.ceil(remaining)} min` : '';

      card.innerHTML = `
        <header>
          <div class="name">${p.name}</div>
          <span class="pill ${p.onField?'on':'off'}">${p.onField?'Feld':'Bank'}</span>
        </header>

        <div class="meta">
          <span class="badge playtime-badge">‚è±Ô∏è <b>${fmtTime(currentPlaytime(p))}</b></span>
          <span class="stats">
            <span class="stat">‚öΩ ${p.goals||0}</span>
            <span class="stat">üÖ∞Ô∏è ${p.assists||0}</span>
          </span>
        </div>

        <div class="progress ${cls}">
          <span style="width:${pct.toFixed(0)}%"></span>
        </div>
        <div class="subline">${sub}</div>
      `;
      playerList.appendChild(card);
    });

    $('scoreUs').textContent = String(scoreUs);
    $('scoreOpp').textContent = String(scoreOpp);
  }

  function applyTickUpdate(){
    $('timer').textContent = fmtTime(elapsedMs());
    document.querySelectorAll('.player').forEach(node=>{
      const id = Number(node.dataset.id);
      const p = players.find(x=>x.id===id); if (!p) return;

      const badgeB = node.querySelector('.playtime-badge b');
      if (badgeB) badgeB.textContent = fmtTime(currentPlaytime(p));

      const targetMin = getTargetMinutesPerPlayer();
      const playedMin = currentPlaytime(p) / 60000;
      const pct = (targetMin > 0) ? Math.min(100, (playedMin/targetMin)*100) : 0;

      const progressSpan = node.querySelector('.progress > span');
      if (progressSpan) progressSpan.style.width = `${pct.toFixed(0)}%`;

      const progress = node.querySelector('.progress');
      if (progress){
        const cls = pctClass(pct);
        progress.classList.remove('red','yellow','green');
        progress.classList.add(cls);
      }

      const sub = node.querySelector('.subline');
      if (sub && targetMin>0){
        const remaining = Math.max(0, targetMin - playedMin);
        sub.textContent = `√ò ${Math.round(targetMin)} min ‚Ä¢ ${Math.ceil(remaining)} min`;
      }
    });
    updateTargetBadge();
  }

  function startClock(){
    if (clock.running) return;
    clock.running = true; clock.startTs = now();
    timerHandle = setInterval(applyTickUpdate, 250);
    log({ts: now(), type:'‚èØÔ∏è Start'});
  }
  function pauseClock(){
    if (!clock.running) return;
    clock.offsetMs += now() - clock.startTs;
    clock.running = false;
    clearInterval(timerHandle); timerHandle=null;
    log({ts: now(), type:'‚è∏Ô∏è Pause'});
    $('pauseBtn').hidden=true; $('resumeBtn').hidden=false;
  }
  function resumeClock(){
    if (clock.running) return;
    clock.running = true; clock.startTs = now();
    timerHandle = setInterval(applyTickUpdate, 250);
    log({ts: now(), type:'‚ñ∂Ô∏è Weiter'});
    $('pauseBtn').hidden=false; $('resumeBtn').hidden=true;
  }

  function finalizeTimes(){
    const nowTs = now();
    players.forEach(p=>{
      if (p.squad!=='out' && p.onField){
        const startRef = p.lastSwitchTs ?? matchStartTs ?? nowTs;
        p.totalMs += nowTs - startRef;
        p.lastSwitchTs = null;
        p.onField = false;
      }
    });
  }

  function showSummary(){
    const metaParts = [];
    if ((opponentName||"").trim()) metaParts.push(`vs ${opponentName.trim()}`);
    metaParts.push(`${matchTotalMinutes} min`);
    $('sumMetaLine').textContent = `Endstand: ${scoreUs}:${scoreOpp}` + (metaParts.length ? ` ‚Ä¢ ${metaParts.join(' ‚Ä¢ ')}` : "");

    const tbody = $('summaryTable').querySelector('tbody');
    tbody.innerHTML = '';

    const targetMin = getTargetMinutesPerPlayer();

    const rows = players
      .filter(p=>p.squad!=='out')
      .map(p=>({
        name:p.name,
        ms:p.totalMs,
        timeStr:fmtTime(p.totalMs),
        goals:p.goals||0,
        assists:p.assists||0
      }))
      .sort((a,b)=> b.ms - a.ms);

    rows.forEach(r=>{
      const playedMin = r.ms / 60000;
      const pct = (targetMin > 0) ? Math.min(100, (playedMin/targetMin)*100) : 0;
      const cls = pctClass(pct);

      const tr = document.createElement('tr');
      tr.dataset.pct = String(pct);

      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="td-right">${r.timeStr}</td>
        <td class="td-right">${r.goals}</td>
        <td class="td-right">${r.assists}</td>
        <td>
          <div class="progress ${cls}" style="min-width:140px">
            <span style="width:${pct.toFixed(0)}%"></span>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    $('summaryModal').hidden = false;
  }

  function endMatch(){
    if (clock.running){
      clock.offsetMs += now() - clock.startTs;
      clearInterval(timerHandle); timerHandle = null;
      clock.running = false;
    }
    finalizeTimes();

    const matchObj = {
      id: currentMatchId || uuid(),
      createdAt: new Date().toISOString(),
      opponent: (opponentName || "").trim(),
      totalMinutes: Number(matchTotalMinutes) || 0,
      onFieldMax,
      scoreUs, scoreOpp,
      players: players
        .filter(p=>p.squad!=='out')
        .map(p=>({ name: p.name, totalMs: p.totalMs, goals: p.goals||0, assists: p.assists||0 }))
    };
    addToHistory(matchObj);

    showSummary();
  }

  function closeSummaryToSetup(){
    selection.playerId = null;
    clock = { running:false, startTs:null, offsetMs:0 };
    $('timer').textContent = '00:00';
    showSetup();
    renderSetup();
    renderPlayers();
  }

  /* ===== Swap Wizard ===== */
  function openSwapWizard(){
    swapOutSet.clear(); swapInSet.clear();
    renderSwapStep1();
    $('swapStep1').hidden=false;
    $('swapStep2').hidden=true;
    $('swapWizard').hidden=false;
  }
  function closeSwapWizard(){
    $('swapWizard').hidden=true;
    swapOutSet.clear(); swapInSet.clear();
  }
  function renderSwapStep1(){
    const fieldList = $('swapFieldList');
    fieldList.innerHTML = '';
    players.filter(p=>p.squad!=='out' && p.onField).forEach(p=>{
      const chip = document.createElement('button');
      chip.type='button';
      chip.className = 'chip' + (swapOutSet.has(p.id) ? ' outPick' : '');
      chip.textContent = p.name;
      chip.addEventListener('click', ()=>{
        if (swapOutSet.has(p.id)) swapOutSet.delete(p.id);
        else swapOutSet.add(p.id);
        renderSwapStep1();
      });
      fieldList.appendChild(chip);
    });
    $('swapNext').disabled = (swapOutSet.size === 0);
  }
  function renderSwapStep2(){
    const need = swapOutSet.size;
    $('swapNeeded').textContent = String(need);
    $('swapHave').textContent = String(swapInSet.size);

    const benchList = $('swapBenchList');
    benchList.innerHTML = '';
    players.filter(p=>p.squad!=='out' && !p.onField).forEach(p=>{
      const chip = document.createElement('button');
      chip.type='button';
      chip.className = 'chip' + (swapInSet.has(p.id) ? ' inPick' : '');
      chip.textContent = p.name;
      chip.addEventListener('click', ()=>{
        if (swapInSet.has(p.id)) swapInSet.delete(p.id);
        else if (swapInSet.size < need) swapInSet.add(p.id);
        renderSwapStep2();
      });
      benchList.appendChild(chip);
    });
    $('swapConfirm').disabled = !(swapInSet.size === need && need>0);
  }
  function applySwapBatch(){
    const n = swapOutSet.size;
    if (n===0 || swapInSet.size!==n) return;

    const nowTs = now();
    const outArr = Array.from(swapOutSet);
    const inArr  = Array.from(swapInSet);

    for (let i=0; i<n; i++){
      const outId = outArr[i], inId = inArr[i];
      const outP = players.find(p=>p.id===outId);
      const inP  = players.find(p=>p.id===inId);
      if (!outP || !inP) continue;
      if (!outP.onField || inP.onField) continue;

      if (clock.running){ outP.totalMs += nowTs - (outP.lastSwitchTs ?? (matchStartTs || nowTs)); }
      outP.lastSwitchTs = null; outP.onField = false;
      if (selection.playerId===outP.id) selection.playerId=null;
      queueSubOut(outP.name);

      inP.onField = true; inP.lastSwitchTs = nowTs;
      queueSubIn(inP.name);
    }

    renderPlayers();
    closeSwapWizard();
  }

  /* ===== Tore/Assists ===== */
  function promptAssistFor(scorerId){
    const body = $('assistBody');
    const onField = players.filter(p=>p.squad!=='out' && p.onField && p.id!==scorerId);
    body.innerHTML = onField.length
      ? `<select id="assistSelect" style="width:100%">
           <option value="">‚Äî Ohne Assist ‚Äî</option>
           ${onField.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
         </select>`
      : `<div class="badge">Keine Auswahl</div>`;
    $('assistModal').hidden = false;
  }

  function recordGoalWithAssist(scorerId, assistIdOrNull){
    const scorer = players.find(p=>p.id===scorerId); if (!scorer) return;
    scoreUs += 1; $('scoreUs').textContent = String(scoreUs);
    scorer.goals = (scorer.goals||0) + 1;

    let assistName = '';
    if (assistIdOrNull){
      const a = players.find(p=>p.id===assistIdOrNull);
      if (a){ a.assists=(a.assists||0)+1; assistName=a.name; }
    }
    log({ts: now(), type:'‚öΩ Tor', name: scorer.name, assistName: assistName || undefined, side:'us'});
    renderPlayers();
  }

  function addGoalFlow(){
    if (!selection.playerId){ alert('Torsch√ºtze markieren.'); return; }
    const scorer = players.find(p=>p.id===selection.playerId);
    if (!scorer || !scorer.onField){ alert('Torsch√ºtze muss auf dem Feld sein.'); return; }
    promptAssistFor(scorer.id);
  }

  function ownGoal(){
    scoreOpp += 1; $('scoreOpp').textContent = String(scoreOpp);
    log({ts: now(), type:'‚ö†Ô∏è Gegentor', side:'opp'});
  }

  /* ===== Export CSV ===== */
  function exportCSV_All(){
    const lines = [];
    lines.push(['Zeit','Spielminute','Typ','Spieler','Assist','Extra','Seite','Raus','Rein'].join(','));
    events.forEach(e=>{
      const sys = new Date(e.ts).toLocaleString();
      lines.push([
        sys,
        `${e.min ?? matchMinute()}'`,
        e.type,
        (e.name||''),
        (e.assistName||''),
        (e.extra||''),
        (e.side||'us'),
        (e.outName||''),
        (e.inName||'')
      ].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
    });

    lines.push('');
    lines.push('--- Spieler-Zusammenfassung ---');
    lines.push(['Name','Spielzeit (Sekunden)','Spielzeit (mm:ss)','Tore','Assists','Endstand Wir','Endstand Gegner','Gegner','Gesamtmin'].join(','));

    players.filter(p=>p.squad!=='out').forEach((p,i)=>{
      const sec = Math.round(p.totalMs/1000);
      const endCols = i===0 ? [scoreUs, scoreOpp] : ['', ''];
      const extraCols = i===0 ? [opponentName || '', matchTotalMinutes] : ['', ''];
      lines.push([`"${p.name.replaceAll('"','""')}"`, sec, fmtTime(p.totalMs), p.goals||0, p.assists||0, ...endCols, ...extraCols].join(','));
    });

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `spiel_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportTableAsCSV(tableEl, filenamePrefix){
    if (!tableEl) { alert('Tabelle fehlt.'); return; }
    const rows = Array.from(tableEl.querySelectorAll('tr'));
    const lines = [];
    rows.forEach(tr=>{
      const cells = Array.from(tr.querySelectorAll('th,td')).map(td =>
        `"${td.textContent.trim().replaceAll('"','""')}"`
      );
      lines.push(cells.join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${filenamePrefix}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /* ===== WhatsApp Bild (Summary als PNG, inkl. Zielbalken) ===== */
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function ellipsize(ctx, text, maxWidth){
    if (!text) return '';
    if (ctx.measureText(text).width <= maxWidth) return text;
    let s = text;
    while (s.length > 1 && ctx.measureText(s + '‚Ä¶').width > maxWidth) s = s.slice(0, -1);
    return s + '‚Ä¶';
  }
  function barColorForPct(pct){
    if (pct >= 70) return '#22c55e';
    if (pct >= 45) return '#f59e0b';
    return '#ef4444';
  }

  async function shareSummaryAsImage(){
    const table = document.getElementById('summaryTable');
    const meta = document.getElementById('sumMetaLine')?.textContent || '';
    if (!table) { alert('Tabelle fehlt.'); return; }

    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
      const tds = tr.querySelectorAll('td');
      return {
        name: (tds[0]?.textContent || '').trim(),
        time: (tds[1]?.textContent || '').trim(),
        goals: (tds[2]?.textContent || '').trim(),
        assists: (tds[3]?.textContent || '').trim(),
        pct: Math.max(0, Math.min(100, Number(tr.dataset.pct || 0)))
      };
    });

    // Canvas ‚Äì dynamisch (14 Spieler passt locker)
    const pad = 28;
    const rowH = 48;
    const headerH = 54;
    const titleH = 64;
    const w = 1080;
    const h = pad + titleH + headerH + rows.length * rowH + pad;

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');

    // BG
    ctx.fillStyle = '#0b0f19';
    ctx.fillRect(0, 0, w, h);

    // Card
    const cardX = pad, cardY = pad, cardW = w - pad*2, cardH = h - pad*2;
    ctx.fillStyle = '#111827';
    roundRect(ctx, cardX, cardY, cardW, cardH, 26);
    ctx.fill();

    // Title
    ctx.fillStyle = '#e5e7eb';
    ctx.font = '900 36px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('Spiel-Zusammenfassung', cardX + 26, cardY + 52);

    // Meta
    ctx.fillStyle = '#9ca3af';
    ctx.font = '800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText(meta, cardX + 26, cardY + 84);

    const startY = cardY + 110;

    // Header row
    ctx.fillStyle = '#0b1220';
    roundRect(ctx, cardX + 18, startY, cardW - 36, headerH, 18);
    ctx.fill();

    ctx.fillStyle = '#cbd5e1';
    ctx.font = '900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('Spieler', cardX + 40, startY + 34);
    ctx.fillText('Zeit',    cardX + 520, startY + 34);
    ctx.fillText('Tore',    cardX + 720, startY + 34);
    ctx.fillText('Ass',     cardX + 820, startY + 34);
    ctx.fillText('Ziel',    cardX + 910, startY + 34);

    // Rows
    let y0 = startY + headerH;
    rows.forEach((r, i) => {
      const y = y0 + i * rowH;

      ctx.fillStyle = (i % 2 === 0) ? '#0d1427' : '#0c1324';
      roundRect(ctx, cardX + 18, y, cardW - 36, rowH - 6, 14);
      ctx.fill();

      ctx.fillStyle = '#e5e7eb';
      ctx.font = '900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(ellipsize(ctx, r.name, 440), cardX + 40, y + 30);

      ctx.fillStyle = '#cbd5e1';
      ctx.font = '800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(r.time, cardX + 520, y + 30);
      ctx.fillText(r.goals, cardX + 740, y + 30);
      ctx.fillText(r.assists, cardX + 840, y + 30);

      // Zielbalken (mini)
      const bx = cardX + 910;
      const by = y + 18;
      const bw = 140;
      const bh = 14;

      ctx.fillStyle = '#0b1220';
      roundRect(ctx, bx, by, bw, bh, 999);
      ctx.fill();

      ctx.fillStyle = barColorForPct(r.pct);
      roundRect(ctx, bx, by, Math.max(0, Math.min(bw, (bw * r.pct / 100))), bh, 999);
      ctx.fill();
    });

    // Footer
    ctx.fillStyle = '#64748b';
    ctx.font = '700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('Spiel-Tracker', cardX + 26, cardY + cardH - 22);

    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.92));
    if (!blob) { alert('Bild-Export fehlgeschlagen.'); return; }

    const file = new File([blob], `spielbericht_${new Date().toISOString().slice(0,10)}.png`, { type:'image/png' });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      try{
        await navigator.share({ files: [file], title: 'Spielbericht' });
        return;
      }catch(_){}
    }

    // Fallback Download
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = file.name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /* ===== Historie: Gesamt √ºber 15 Spiele ===== */
  function renderHistoryTotals(){
    const list = loadHistory().slice(0, HISTORY_LIMIT);
    const map = new Map();

    list.forEach(m=>{
      (m.players || []).forEach(p=>{
        const name = (p.name || '').trim();
        if (!name) return;
        const cur = map.get(name) || { ms:0, goals:0, assists:0 };
        cur.ms += Number(p.totalMs || 0);
        cur.goals += Number(p.goals || 0);
        cur.assists += Number(p.assists || 0);
        map.set(name, cur);
      });
    });

    const rows = Array.from(map.entries())
      .map(([name, v])=>({ name, ms:v.ms, goals:v.goals, assists:v.assists }))
      .sort((a,b)=> b.ms - a.ms);

    const tbody = document.querySelector('#historyTotalsTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!rows.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" style="color:#9ca3af">Keine Daten</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="td-right">${fmtTime(r.ms)}</td>
        <td class="td-right">${r.goals}</td>
        <td class="td-right">${r.assists}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* ===== Historie UI ===== */
  let selectedHistoryId = null;

  function openHistory(){
    renderHistoryTotals();
    renderHistoryList();
    $('historyModal').hidden = false;
  }
  function closeHistory(){
    $('historyModal').hidden = true;
  }
  function renderHistoryList(){
    const list = loadHistory();
    const wrap = $('historyList');
    wrap.innerHTML = '';

    if (!list.length){
      wrap.innerHTML = `<div class="badge">Keine Spiele gespeichert</div>`;
      return;
    }

    list.forEach(m=>{
      const opp = (m.opponent && m.opponent.trim()) ? `vs ${m.opponent.trim()}` : 'ohne Gegner';
      const title = `${fmtDateShort(m.createdAt)} ‚Ä¢ ${opp}`;
      const sub = `${m.totalMinutes || ''} min ‚Ä¢ ${m.onFieldMax || ''} auf Feld`;
      const score = `${m.scoreUs}:${m.scoreOpp}`;

      const item = document.createElement('div');
      item.className = 'history-item';
      item.dataset.id = m.id;
      item.innerHTML = `
        <div>
          <div class="history-title">${title}</div>
          <div class="history-sub">${sub}</div>
        </div>
        <div class="history-score">${score}</div>
      `;
      item.addEventListener('click', ()=> openHistoryDetail(m.id));
      wrap.appendChild(item);
    });
  }

  function openHistoryDetail(matchId){
    selectedHistoryId = matchId;
    const list = loadHistory();
    const m = list.find(x=>x.id===matchId);
    if (!m) return;

    const opp = (m.opponent && m.opponent.trim()) ? `vs ${m.opponent.trim()}` : '';
    $('histTitle').textContent = `Spiel ${fmtDateShort(m.createdAt)}`;
    $('histMeta').textContent = `${m.scoreUs}:${m.scoreOpp}` + (opp ? ` ‚Ä¢ ${opp}` : '') + (m.totalMinutes ? ` ‚Ä¢ ${m.totalMinutes} min` : '');

    const tbody = $('historyDetailTable').querySelector('tbody');
    tbody.innerHTML = '';

    const rows = (m.players || [])
      .map(p=>({
        name:p.name,
        ms:Number(p.totalMs||0),
        timeStr:fmtTime(Number(p.totalMs||0)),
        goals:Number(p.goals||0),
        assists:Number(p.assists||0)
      }))
      .sort((a,b)=> b.ms - a.ms);

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="td-right">${r.timeStr}</td>
        <td class="td-right">${r.goals}</td>
        <td class="td-right">${r.assists}</td>
      `;
      tbody.appendChild(tr);
    });

    $('historyDetailModal').hidden = false;
  }
  function closeHistoryDetail(){
    $('historyDetailModal').hidden = true;
    selectedHistoryId = null;
  }

  /* ===== Start ===== */
  function startMatch(){
    const startCount = players.filter(p=>p.squad==='start').length;
    if (startCount===0){ alert('Startelf w√§hlen.'); return; }
    if (startCount>onFieldMax){ alert(`Max. ${onFieldMax} Startspieler.`); return; }

    matchTotalMinutes = Math.min(300, Math.max(1, Number(totalMinInput.value) || 60));
    totalMinInput.value = String(matchTotalMinutes);
    saveTotalMinutes();

    opponentName = normalizeName(opponentInput.value);
    opponentInput.value = opponentName;
    saveOpponent();

    currentMatchId = uuid();

    players.forEach(p=>{
      p.onField = (p.squad==='start');
      p.totalMs = 0; p.lastSwitchTs = null;
      p.goals = 0; p.assists = 0;
    });
    selection.playerId = null;
    scoreUs = 0; scoreOpp = 0;
    $('scoreUs').textContent = '0';
    $('scoreOpp').textContent = '0';

    events = [];
    pairQueueOut.length = 0;
    pairQueueIn.length = 0;
    renderEventLog();

    matchStartTs = now();
    players.forEach(p=>{ if (p.onField) p.lastSwitchTs = matchStartTs; });

    if (opponentName){
      matchOpponentBadge.hidden = false;
      matchOpponentBadge.textContent = `vs ${opponentName}`;
    } else {
      matchOpponentBadge.hidden = true;
    }

    $('timer').textContent = '00:00';
    clock = { running:false, startTs:null, offsetMs:0 };
    $('pauseBtn').hidden=false; $('resumeBtn').hidden=true;

    renderPlayers();
    showMatch();
    startClock();
  }

  /* ===== Events / Delegation ===== */
  setupGrid.addEventListener('click', (e)=>{
    const delBtn = e.target.closest('button[data-action="delete"]');
    if (delBtn){
      e.stopPropagation();
      deletePlayer(Number(delBtn.dataset.id));
      return;
    }
    const btn = e.target.closest('.btn-player');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    cycleState(id);
  });

  playerList.addEventListener('click', (e)=>{
    const card = e.target.closest('.player');
    if (!card) return;
    const id = Number(card.dataset.id);
    const p = players.find(x=>x.id===id);
    if (!p || !p.onField) return;
    selection.playerId = (selection.playerId===id ? null : id);
    renderPlayers();
  });

  /* ===== Bindings ===== */
  $('startBtn').addEventListener('click', ()=>{ if(!$('startBtn').disabled) startMatch(); });
  $('resetSetupBtn').addEventListener('click', ()=>{ players.forEach(p=>p.squad='out'); renderSetup(); saveRosterNames(); });
  $('resetRosterBtn').addEventListener('click', ()=>{
    if (!confirm('Standard-Kader laden?')) return;
    buildRoster(DEFAULT_ROSTER);
    saveRosterNames();
  });

  $('addPlayerBtn').addEventListener('click', ()=>{
    addPlayer($('newPlayerName').value);
    $('newPlayerName').value = '';
  });
  $('newPlayerName').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      addPlayer($('newPlayerName').value);
      $('newPlayerName').value = '';
    }
  });

  $('onFieldMax').addEventListener('change', ()=>{
    onFieldMax = Number($('onFieldMax').value);
    renderSetup();
  });

  totalMinInput.addEventListener('change', ()=>{
    matchTotalMinutes = Math.min(300, Math.max(1, Number(totalMinInput.value) || 60));
    totalMinInput.value = String(matchTotalMinutes);
    saveTotalMinutes();
    updateTargetBadge();
  });

  opponentInput.addEventListener('change', ()=>{
    opponentName = normalizeName(opponentInput.value);
    opponentInput.value = opponentName;
    saveOpponent();
  });

  $('pauseBtn').addEventListener('click', pauseClock);
  $('resumeBtn').addEventListener('click', resumeClock);
  $('endBtn').addEventListener('click', endMatch);
  $('goalBtn').addEventListener('click', addGoalFlow);
  $('ownGoalBtn').addEventListener('click', ownGoal);

  $('toggleEventsBtn').addEventListener('click', ()=>{
    const wrap = $('eventsWrap');
    wrap.hidden = !wrap.hidden;
  });

  $('swapWizardBtn').addEventListener('click', openSwapWizard);
  $('swapCancel1').addEventListener('click', closeSwapWizard);
  $('swapCancel2').addEventListener('click', closeSwapWizard);
  $('swapNext').addEventListener('click', ()=>{
    $('swapStep1').hidden = true;
    swapInSet.clear();
    renderSwapStep2();
    $('swapStep2').hidden = false;
  });
  $('swapBack').addEventListener('click', ()=>{
    $('swapStep2').hidden = true;
    renderSwapStep1();
    $('swapStep1').hidden = false;
  });
  $('swapConfirm').addEventListener('click', applySwapBatch);

  // Bottom bar
  $('bbSwap').addEventListener('click', openSwapWizard);
  $('bbGoal').addEventListener('click', addGoalFlow);
  $('bbEnd').addEventListener('click', endMatch);

  // Assist modal
  $('assistCancel').addEventListener('click', ()=>{ $('assistModal').hidden = true; });
  $('assistNone').addEventListener('click', ()=>{
    $('assistModal').hidden = true;
    recordGoalWithAssist(selection.playerId, null);
  });
  $('assistConfirm').addEventListener('click', ()=>{
    const sel = $('assistSelect');
    let assistId = null; if (sel && sel.value) assistId = Number(sel.value);
    $('assistModal').hidden = true;
    if (assistId === selection.playerId){ alert('Assist ‚â† Torsch√ºtze.'); return; }
    recordGoalWithAssist(selection.playerId, assistId);
  });

  // Summary modal
  $('summaryShareImgBtn').addEventListener('click', shareSummaryAsImage);
  $('summaryExportTableBtn').addEventListener('click', ()=> exportTableAsCSV($('summaryTable'), 'summary_table'));
  $('summaryExportAllBtn').addEventListener('click', exportCSV_All);
  $('summaryCloseBtn').addEventListener('click', ()=>{
    $('summaryModal').hidden = true;
    closeSummaryToSetup();
  });

  // History
  $('historyBtn').addEventListener('click', openHistory);
  $('historyCloseBtn').addEventListener('click', closeHistory);
  $('historyClearBtn').addEventListener('click', ()=>{
    if (!confirm('Historie l√∂schen?')) return;
    clearHistory();
    renderHistoryTotals();
    renderHistoryList();
  });

  $('historyTotalsToggleBtn').addEventListener('click', ()=>{
    const wrap = $('historyTotalsWrap');
    wrap.hidden = !wrap.hidden;
    $('historyTotalsToggleBtn').textContent = wrap.hidden ? 'anzeigen' : 'verbergen';
  });

  $('historyDetailCloseBtn').addEventListener('click', closeHistoryDetail);
  $('historyDetailExportBtn').addEventListener('click', ()=> exportTableAsCSV($('historyDetailTable'), 'history_table'));
  $('historyDetailDeleteBtn').addEventListener('click', ()=>{
    if (!selectedHistoryId) return;
    if (!confirm('Dieses Spiel l√∂schen?')) return;
    deleteFromHistory(selectedHistoryId);
    closeHistoryDetail();
    renderHistoryTotals();
    renderHistoryList();
  });

  /* ===== Init ===== */
  function init(){
    onFieldMax = Number($('onFieldMax').value || 11);
    loadTotalMinutes();
    loadOpponent();
    buildRoster(loadRosterNames());
    showSetup();
    $('timer').textContent = '00:00';
    renderPlayers();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    init();
  }
})();
</script>

<!-- Service Worker -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js")
        .then(() => console.log("Service Worker registriert"))
        .catch(err => console.error("SW-Fehler:", err));
    });
  }
</script>

<!-- iOS: Double-Tap Zoom block (optional) -->
<script>
  (function(){
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });

    let lastTouchStart = 0;
    document.addEventListener('touchstart', function(e){
      const now = Date.now();
      if (now - lastTouchStart <= 300) e.preventDefault();
      lastTouchStart = now;
    }, { passive: false });
  })();
</script>

</body>
</html>
